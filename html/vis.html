<meta name="viewport" content="width=device-width, initial-scale=1.0"/> 

{% if runMode == 'pilot' %}
{% if noChat == false %}
<link rel="stylesheet" href="script/chat.css" />
{% endif %}
<link rel="manifest" href="manifest.json">
{% endif %}

<link rel="stylesheet" href="script/base.css" />
<link rel="stylesheet" href="script/dialogs.css" />
<link rel="stylesheet" href="script/plottool.css" />
<link rel="stylesheet" href="script/spincontrol.css" />
<link rel="stylesheet" href="script/annunciate.css" />
<link rel="stylesheet" href="script/loader.css" />

<script src="script/plotly-latest.min.js"></script>
<script src="script/util.js"></script>
<script src="script/dialogs.js"></script>
<script src="script/websocket.js"></script>
<script src="script/tabstats.js"></script>
<script src="script/spincontrol.js"></script>
<script src="script/annunciate.js"></script>

{% if runMode == 'pilot' %}
<script src="script/chat.js"></script>
{% endif %}
<style>
    .hide {
        display: none !important;
    }
    .pre {
        display: block;
        unicode-bidi: embed;
        font-family: monospace;
        white-space: pre;
    }
    .bold {
        font-weight: bold;
    }
    .paramSearched {
       background-color: #FFFF00;
    }
    .paramInputLabel {
        padding-left: 5px;
        width: 50%;
    }
    .paramInputHolder {
        width: 50%;
        border-style: none;
        border-width: 0px;
        display: flex;
        overflow-x: visible;
    }
    .paramInputInput {
        width: 50%;
        border-style: none;
        border-width: 0px;
    }
    .paramInputDiv {
        padding: 4px;
        display: flex;    
        overflow-x: visible;
    }
    .vertRow th {
        writing-mode: sideways-lr;
        vertical-align: bottom;
        horitzontal-align: center;
    }
    #thDepthLims {
        writing-mode: horizontal-tb !important;
    }
    .selected-target {
        background-color: #FFFF00;
    }
    .fileDirty {
        background-color: rgb(152,255,152);
    }
    .processing:after {
      overflow: hidden;
      display: inline-block;
      vertical-align: bottom;
      -webkit-animation: ellipsis steps(4, end) 900ms infinite;
      animation: ellipsis steps(4, end) 900ms infinite;
      content: "\2026";
      /* ascii code for the ellipsis character */
      width: 0px;
    }

    @keyframes ellipsis {
      to {
        width: 20px;
      }
    }

    @-webkit-keyframes ellipsis {
      to {
        width: 20px;
      }
    }
</style>

<script>

    // the default beep is no beep
    function beep() {
        console.log('beep');
    }

    var mobile = false;
    var alertOverride = false;

    var blurTimer  = false;
    var isBlurred  = false;
    var isFlashing =false;
    var currTitle  = "";

    var currGlider = '';
    var currMission = '';
    var currProject = '';
    var currStatus = '';
    var targetsChannel = null;

    var engplots = [];
    var engplotlyplots = [];
    var sgplots = [];
    var sgplotlyplots = [];

    var startX = null;
    var startY = null;
    var startZ = null;
    var startOp = null;
    var lastDive = null;

    var permalink = null;

    var divesInTable = [];

    var parms = [];
    var parms_SENSORS = null;
    var parms_TGT_NAME = null;
 
    var sectionSortMajor = 'number';
    var sectionNumberSort = 'reverse';

    var edit_log_auth_failure = false;

{% if runMode == 'pilot' %}
    var fixes = [];
    var connect_t = 0;

    var fixTimer = null;
{% endif %}

    function showPermalink() {
        var link;
        let params = new URLSearchParams(window.location.search);
        let path = window.location.href.split('?')[0];
        if (params && params.has('mission'))
            link = path + '?mission=' + params.get('mission') + '&' + permalink;
        else
            link = path + '?' + permalink;

        alert(link);
    }

    function startFlash() {
        isFlashing = true;
        blurTimer = window.setInterval(function() 
            {
                document.title = document.title == currTitle ? currTitle + "..." : currTitle;
            }, 1000);
    }
 
    window.onblur=function() {
        isBlurred = true;
    }

    window.onfocus=function() { 
        isBlurred = false;
        isFlashing = false;
        document.title = currTitle;
        if (blurTimer) {
            clearInterval(blurTimer);
        }
        blurTimer = false;
    }

    function mission() {
        if (currMission != '')
            return `?mission=${currMission}`;
        else
            return '';
    }

{% if runMode == 'pilot' %}

    var currProcess = null;
    
    function updateTimer() {
        if (fixes.length > 0) {
            $('lastFix').innerHTML = '' + (Date.now()/1000 - fixes.at(-1).t).toFixed(0) + 's';
        }
        if (connect_t > 0) {
            $('lastConnect').innerHTML = '' + (Date.now()/1000 - connect_t).toFixed(0) + 's';
        }
        fixTimer = setTimeout('updateTimer()', 1000);

        var d = new Date().toISOString();
        $('currentDate').innerHTML = d.slice(0,10);
        $('currentTime').innerHTML = d.slice(11,19);

        if (currProcess)
            updateProcessBar();
    }

    const process_progress_sections = [
        "dive_files",      "per_dive_netcdfs",   "flight_model",  "update_db",   "per_dive_plots", "per_dive_extensions",
        "mission_profile", "mission_timeseries", "mission_plots", "mission_kml", "mission_extensions"
    ];

    const processClasses = ["processBarGreen", "processBarRed", "processBarYellow", "processBarX", "processBarCheck"];
    const processColors = ["processBarGreen", "processBarRed", "processBarYellow"];
    const processMarks  = ["processBarX", "processBarCheck"];

    var processResults = {}



    function formatProcessResults() 
    {
        var s;
        out = '<table>';
        for (var i = 0 ; i < process_progress_sections.length ; i++) {
            out += '<tr><td>' + process_progress_sections[i].replaceAll('_', ' ');
            if (process_progress_sections[i] in processResults) {
                const status = processResults[process_progress_sections[i]].status;
                if (status == 'skipped') {
                    out += '<td>skipped<td>' + processResults[process_progress_sections[i]].reason;
                }
                else if (status == 'completed') {
                    out += '<td>completed<td>ran ' + processResults[process_progress_sections[i]].elapsed.toFixed(2) + ' s';
                }
                else if (status == 'started') {
                    const now = Date.now()/1000;
                    out += '<td>started<td>running ' + (now - processResults[process_progress_sections[i]].start).toFixed(2) + ' s';
                }
            }
            else {
                out += '<td><td>';
            }
            out += '</tr>';
        } 
        out += '</table>';
        return out;
    }

    var processTimer = null;

    function updateProcessTimer() {
        $('processPopupContents').innerHTML = formatProcessResults();
        processTimer = setTimeout('updateProcessTimer()', 100);
    }

    function popupProcessResults() {
        $('processPopup').style.display = 'block';
        $('processPopupContents').innerHTML = formatProcessResults();
    }

    function closeProcessResults() {
        $('processPopup').style.display = 'none';
        if (processTimer)
            clearTimeout(processTimer);

        processTimer = null;
    }
 
    function setupProcessBar()
    {
        var s;
        $('processProgressBar').innerHTML = '';
        for (var i = 0 ; i < process_progress_sections.length ; i++) {
            s = document.createElement('span');
            s.id = 'process_' + process_progress_sections[i];
            s.title = process_progress_sections[i].replaceAll('_', ' ');
            $('processProgressBar').appendChild(s);
        }

    }

    function completeProcessBar(returnCode)
    {
        var s;
        if (!currProcess || returnCode == 0)
            return;

        const last = process_progress_sections.indexOf(currProcess['section']);
        for (var i = last ; i < process_progress_sections.length ; i++) {
            s = $('process_' + process_progress_sections[i]);
            if (!s.classList.contains('processBarCheck') && !s.classList.contains('processBarX')) {
                s.classList.add('processBarX');
                s.title += ' ' + 'skipped: basestation error';
                processResults[process_progress_sections[i]].status = 'skipped';
                processResults[process_progress_sections[i]].reason = 'basestation error';
            }
        }
    }

    function clearProcessBar()
    {
        var s;
        for (var i = 0 ; i < process_progress_sections.length ; i++) {
            s = $('process_' + process_progress_sections[i]);
            s.classList.remove(...processClasses);
            s.title = process_progress_sections[i].replaceAll('_', ' ');
        }
        processReults = {};
    }

    function updateProcessBar()
    {
        if (currProcess == null) 
            return;
  
        const s = $('process_' + currProcess['section']); 
        const now = Date.now()/1000; 
        if (!s.classList.contains('processBarRed') && currProcess['red'] > 0 && now > currProcess['time'] + currProcess['red']) {
            s.classList.remove(...processColors);
            s.classList.add('processBarRed');
        }
        else if (!s.classList.contains('processBarRed') && !s.classList.contains('processBarYellow') && currProcess['yellow'] > 0 && now > currProcess['time'] + currProcess['yellow']) {
            s.classList.remove(...processColors);
            s.classList.add('processBarYellow');
        }
    }

{% endif %}

    let wsocket  = null;
    var first = true;

    function setupStream(glider, first, history) {
        console.log('setting up stream');
        var loc = window.location, new_uri;
        if (loc.protocol === "https:")
            new_uri = "wss:";
        else
            new_uri = "ws:";

        let which = 'restart';
        if (first)
            which = 'init';
        else if (history)
            which = 'history';
        
{% if runMode == 'pilot' %}
{% if noChat == false %}
        if (first || history) {
            $('chatContent').innerHTML = '';
        }
{% endif %}
{% endif %}

        path = loc.pathname.split('/').slice(0,-1).join('/');
        new_uri += "//" + loc.host + path;
        new_uri += "/stream/" + which + "/" + glider + mission();
        console.log(new_uri);
        wsocket = new ReconnectingWebSocket(new_uri);
        wsocket.timeoutInterval = 10000;
        wsocket.reconnectInterval = 10000;
        wsocket.maxReconnectAttempts = 12;
        wsocket.debug = true;

        wsocket.onopen = function() {
            wsocket.url = wsocket.url.replace('init', 'restart');
        }

        wsocket.onerror = function(error) {
            console.log('stream error detected');
            console.log(error)
        };

        wsocket.onclose = function(e) {
            if (e.wasClean) {
                console.log('stream closed cleanly');
            }
            else {
                console.log('connection died');
            }
        };

        var lastChat_t = 0;

        wsocket.onmessage = function(e) { 
            var pieces, content, data, i;
            var vals = {};
            var update;
            var newDive;
            var newCmdfile;
            var d, pieces, lines;
            var pt, fix;
            var h;
            var styles = ["font-weight:bold;", "font-weight:bold; color:red;", "font-weight:bold; color:green;"]
            var bolds = {"targets":0, "science":0, "cmdfile":0, "pdoscmds.bat":0, "Connected":0, "QUIT":1, "RECOV_CODE":1, "GO":2};

            var line = e.data;
            
            if (line == 'invalid') {
                console.log('invalid');
                wsocket.close();
            }

            if (line.startsWith('START')) {
                console.log('got START ping');
            }
{% if runMode == 'pilot' %}
            else if (line.startsWith('CHAT=')) {
                msgs = JSON.parse(line.slice(5));
                for (m of msgs) {
                    chatLoadMessage(glider, m);
                }                 
            }
{% endif %}
            else if (line.startsWith('NEW=')) {
                json = JSON.parse(line.slice(4));
                glider = json['glider'];
                console.log('NEW detected ' + line);
                if ('content' in json && (json['content'] == 'files=all' || json['content'] == 'files=perdive') && 
                     (json['when'] == 'socket' || json['when'] == 'sync') ) {
                    newDive = json['dive'];
                    console.log('newDive = ' + newDive + ' maxDive = ' + maxDive);
                    
                    if (newDive >= maxDive) {
                        maxDive = newDive;
                        updateMaxDive();
                        console.log("NEW maxDive=" + maxDive);
                        loadPlots(newDive, true);
                        buildTable(currGlider, newDive);
                        buildChangelog(3);
                        loadRecs();
                        loadAnnunciators(currGlider);
                    }
                }
                else if ('lat' in json) {
                    if (!first) beep();
                    
                    connect_t = json['connected'];
                    if (fixTimer == null) {
                        updateTimer();

                    }

                    if (fixes.length == 0 || fixes.at(-1).t < json['epoch']) {
                        console.log('pushing fix at ' + json['epoch']);
                        fixes.push(positionFix(json['lat'], json['lon'], json['epoch']));
                    } 
                    if (fixTimer == null) {
                        updateTimer();
                    }
                    if (fixes.length >= 2) {
                        var sog, cog, dog, dt;
                        dt = fixes.at(-1).t - fixes.at(-2).t;
                        dog = haversine(fixes.at(-1).pt, fixes.at(-2).pt);
                        cog = bearing(fixes.at(-2).pt, fixes.at(-1).pt);
                        sog = dog/dt/0.514;
                        $('SOG').innerHTML = sog.toFixed(2) + 'kts';
                        $('COG').innerHTML = cog.toFixed(1) + '&deg;';
                        $('DOG').innerHTML = dog.toFixed(0) + 'm';
                        $('dt').innerHTML = dt.toFixed(0) + 's';

                        var next_t = (connect_t + dt)*1000; 
                        $('nextCall').innerHTML = new Date(next_t).toISOString().slice(11,19); 
                    }
                    else {
                        $('SOG').innerHTML = '0';
                        $('COG').innerHTML = '0';
                        $('DOG').innerHTML = '0';
                        $('dt').innerHTML = '0';
                        $('nextCall').innerHTML = '-';
                    }

                    $('position').innerHTML = formatPos(dd2ddmm(json['lat'])) + ',' + formatPos(dd2ddmm(json['lon']));
                    $('positionTime').innerHTML = '@ ' + new Date(json['epoch']*1000).toISOString().replace('T', ' ').slice(0,-8);

                    $('RH').innerHTML = json['RH'].toFixed(2);
                    $('intP').innerHTML = json['intP'].toFixed(2);
                    $('volts').innerHTML = json['volts24'].toFixed(2);
                    $('pitch').innerHTML = json['pitch'].toFixed(1);
                    $('depth').innerHTML = json['depth'].toFixed(1);
                    $('dive').innerHTML = json['dive'];
                    $('cycle').innerHTML = json['cycle'];
                    $('call').innerHTML = json['call'];
                }
                else if ('uuids' in json) {
                    $('processPendingCount').style.display = 'inline-block';
                    if (json['action'] == 'start') {
                        $('processPendingCount').innerHTML = 'pending: ' + (json['uuids'].length - 1);
                        $('processLabel').innerHTML = 'Running job:';
                        clearProcessBar();
                    }
                    else if (json['action'] == 'complete') {
                        completeProcessBar(json['returncode']);
                        currProcess = null;
                        $('processPendingCount').innerHTML = 'pending: ' + (json['uuids'].length - 1);
                        if (json['uuids'].length - 1 == 0) {
                            $('processPendingCount').style.display = 'none';
                            $('processLabel').innerHTML = 'Latest job:';
                        }
                        if (processTimer) clearTimeout(processTimer);
                    }
                    else {
                        $('processPendingCount').innerHTML = 'pending: ' + json['uuids'].length;
                    }
                }
                else if ('section' in json) {
                    const s = $('process_' + json['section']);
                    if (json['action'] == 'start') {
                        $('processLabel').innerHTML = json['section'].replaceAll('_', ' ');
                        s.classList.add('processBarGreen');
                        currProcess = structuredClone(json);
                        processResults[json['section']] = { start: json['time'], status: 'started' };
                        updateProcessTimer();
                    }
                    else if (json['action'] == 'skip') {
                        s.title += ' skipped: ' + json['reason'];
                        // consider: ever need to clean up currProcess that didn't get a completed?
                        s.classList.add('processBarX'); // color?
                        currProcess = null;
                        processResults[json['section']] = { status: 'skipped', reason: json['reason'] };
                        $('processPopupContents').innerHTML = formatProcessResults();
                    }
                    else { // completed
                        s.classList.add('processBarCheck');
                        $('processLabel').innerHTML = 'Running job:';
                        currProcess = null;
                        if (json['section'] in processResults && 'start' in processResults[json['section']]) {
                            processResults[json['section']].elapsed = json['time'] - processResults[json['section']].start;
                            processResults[json['section']].status = 'completed';
                            s.title += ': ' + processResults[json['section']].elapsed.toFixed(2) + ' s';
                        }
                        $('processPopupContents').innerHTML = formatProcessResults();
                        if (processTimer) clearTimeout(processTimer);
                    }
                }
                else {
                    // loadStatus(currGlider, -1);
                    console.log('untreated ' + line); // perdive for example
                }
                // loadLog(newDive);
                first = false;
            }
{% if runMode == 'pilot' %}
            else if (line.startsWith('FILE=')) {
                json = JSON.parse(line.slice(5));
                if (controlFileIsDirty(json['file'])) {
                    let conf = confirm(`${json['file']} has been changed on the basestation, overwrite your changes with those?`);
                    if (conf == false)
                        return;
                }

                if (json['file'].includes('.log')) {
                    loadEditlogContent(json['file'], json['body']);
                }
                else
                    $(json['file']).value = json['body'];

                controlFileMarkClean(json['file']);
                if (json['file'] == 'science') {
                }
                else if (json['file'] == 'targets' && 'data' in json) {
                    loadTargetsList(json['data']);
                }
                else if (json['file'] == 'cmdfile') {
                    console.log('loaded cmdfile, updating parms');
                    updateParmsFromCmdfile(true);
                } 
            }
            else { // new comm.log content comes unprefixed
                var elt = $('commlog');
                for (b of Object.keys(bolds)) {
                    line = line.replaceAll(b, '<span style="' + styles[bolds[b]] + '">' + b + '</span>');
                } 

                elt.innerHTML += line;
                elt.scrollTop = elt.scrollHeight;
            }

{% else %}
            else if (line.startsWith('CMDFILE=')) {
                newDirective = line.split('=')[1];
            }
{% endif %}
            if (isBlurred && !isFlashing) {
                startFlash();
            }
        };
    }

    var currDive = -1;
    var maxDive = 10000; 
    var currElt = 'diveplot';
    var controlFileDive = {};

    var numPages = 0;

    function updateMaxDive() {
        var v2 = $('txtPlotlyLastDive').value;

        if (lastDive) {
            $('txtPlotlyLastDive').value = lastDive;
            lastDive = null;
        }
        else {
            $('txtPlotlyLastDive').value = maxDive;
        }
    }

    function formatValidatorChanges(file, text) {
        if (file == 'cmdfile') {
            var changes = '<table>';
            var other = '';
            var pcs;
            for (var line of text.split('\n')) {
                if (line.includes('will change from')) {
                    pcs = line.split(' ');
                    changes = changes + `<tr><td>${pcs[2]}&nbsp;&nbsp;&nbsp;</td><td>${pcs[6]}</td><td>&#10230;</td><td>${pcs[8]}</td></tr>`
                }
                else  {
                    other = other + line + '<br>';
                }
            }
            changes = changes + '</table>';
            return changes + '<hr>' + other;
        }
        else {
            return '<pre>' + text + '</pre>';
        }
    }

    const miniLoader = '<div class="loader-container-mini"><div class="bouncing-dots"><div class="dot"></div><div class="dot dot1"></div><div class="dot"></div></div></div>';

{% if runMode == 'pilot' %}
{% if noSave == false %}
    function saveControl(file, json) {
        json['file'] = file;
        json['contents'] = $(file).value;

        $('alertPopup').style.display = 'inline-block';
        $('alertContents').innerHTML = miniLoader;

        controlFileMarkClean(file);
        fetch(`save/${currGlider}/${file}${mission()}`, 
        {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(json),
        })
        .then(res => res.text())
        .then(text => {
            if (text.includes("authorization failed")) {
                openLoginForm(function() { loggedIn(); saveControl(file, json); }, "");
                return;
            }
            changes = formatValidatorChanges(file, text);
           
            changes = changes.replace('saved ok', '<b>saved ok</b>'); 
            openMessagePopup(changes, false, null);
            if (!changes.includes("saved ok")) {
                controlFileMarkDirty(file);
            }
        })
        .catch(error => {
            alert(error);
        });
    }
{% else %}
    function saveControl(file, json) {
        return;
    }
{% endif %}
    function submitControl() {
        var file = $('selectFile').value;
        var json = { file: file, contents: $(file).value };

        $('alertPopup').style.display = 'inline-block';
        $('alertContents').innerHTML = miniLoader;

        fetch(`validate/${currGlider}/${file}${mission()}`, 
        {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(json),
        })
        .then(res => res.text())
        .then(text => {
            if (text.includes("authorization failed")) {
                openLoginForm(function() { loggedIn(); submitControl(); }, "");
                return;
            }
            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log('validate ' + text + ' ' + error);
                return;
            }
            txt = formatValidatorChanges(file, data['results']); 
            if ('status' in data && data['status'] == 'ok') {    
{% if noSave == false %}
                openMessagePopup(txt, true, function() { saveControl(file, data); } );
{% else %}
                openMessagePopup(txt, false, null);
{% endif %}
            }
            else {
                txt = txt + '<p><b>errors detected</b>'
                openMessagePopup(txt, false, null);
            }
        })
        .catch(error => {
            console.log('validate ' + error);
        });
    }

    function changeDirective(cmd) {
        var newCmd = '$' + cmd;
        console.log(newCmd + ' ' + cmd);
        var txt = $('cmdfile').value;

        $('radPilotDirective' + cmd).checked = true;

        for (var d of ['$GO', '$QUIT', '$RESUME', '$EXIT_TO_MENU']) {
            if (txt.includes(d)) {
                $('cmdfile').value = $('cmdfile').value.replace(d, newCmd);
                return false;
            }
        }
        txt = txt.trim();
        if (txt != '') txt = txt + '\n';
        $('cmdfile').value = txt + newCmd + '\n'
        return false;
    }

    var controlFileDirty = {};
    function controlFileMarkDirty(which) {
        controlFileDirty[which] = true;
        if ($('selectFile').value == which)
            $('btnSubmit').classList.add('fileDirty');
    }
    function controlFileMarkClean(which) {
        controlFileDirty[which] = false;
        if ($('selectFile').value == which)
            $('btnSubmit').classList.remove('fileDirty');
    }
    function controlFileIsDirty(which) {
        if (which in controlFileDirty && controlFileDirty[which] == true)
            return true;
        else
            return false;
    }

    function editlogShowEntry(which, n) {
        if ($(`${which}Entry${n}`)) {
            if ($(`${which}Entry${n}`).style.display == 'none') 
                $(`${which}Entry${n}`).style.display = 'block';
            else
                $(`${which}Entry${n}`).style.display = 'none';
        }
    }
    function loadEditlogContent(which, contents) {
        var txt = '';
        var n = 0;
        var divOpened = false;

        lines = contents.split('\n');
        for (var i = 0 ; i < lines.length ; i++) {
            if (lines[i].startsWith('###')) {
                if (divOpened) {
                    txt = txt + '</div>';
                }
                txt = txt + `<span class="spanClick" onclick="editlogShowEntry('${which}',${n});">${lines[i]}</span>\n`; 
                txt = txt + `<div id="${which}Entry${n}" style="display: none;">`
                divOpened = true;
                n = n + 1;
            }
            else {
                txt = txt + lines[i] + '\n';
            }
        }

        if (divOpened) {
            txt = txt + '</div>';
        }
        $(which).innerHTML = txt;
        if (n > 0) {
            console.log('showing ' + n - 1);
            editlogShowEntry(which, n - 1);
            $(`${which}Entry${n-1}`).scrollIntoView(true);
            $(which).scrollTop = $(which).scrollHeight;
        }
    }

    function loadEditlog(which) {
        fetch(`editlog/${currGlider}/${which}/${mission()}`)
        .then(res => res.text())
        .then(text => {
            if (text == "none") 
                return;
            if (text.includes("authorization failed")) {
                // fail silently but remember this in the event the user comes
                // to the tab so we can prompt them to login
                edit_log_auth_failure = true;
                return;
            }
            else {
                edit_log_auth_failure = false;
            }

            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log(text + ' ' + error);
                return;
            }
            
            loadEditlogContent(which, data['contents']);
        });
    }

    function loadControlFile(file) {
        fetch(`control/${currGlider}/${file}${mission()}`)
        .then(res => res.text())
        .then(text => {
            if (text == "none" || text.includes("not found") || text.includes("authorization failed"))
                return;

            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log(file + ' ' + text + ' ' + error);
                return;
            }

            if ('error' in data) {
                console.log(data['error']);
                return;
            }

            if ('file' in data && data['file'] == file) {
                $(file).value = data['contents'];
                if (file == 'science') {
                    initScienceFileTable('data' in data ? data['data'] : null);
                }
                else if (file == 'targets' && 'data' in data && data['data']) {
                    console.log(data['data']);
                    loadTargetsList(data['data']);
                }
                if (file == 'cmdfile') {
                    console.log('updated cmdfile value, updating parms');
                    updateParmsFromCmdfile(true);
                }
            }
            if ('dive' in data && data['dive'] > -1) {
                if ('call' in data && data['call'] > -1) {
                    controlFileDive[file] = `${data['dive']}.${data['call']}`;
                }
                else {
                    controlFileDive[file] = `${data['dive']}`;
                }
            }

        })
        .catch(error => {
            console.log(`${file}-${error}`);
        })
    }

    const knownFiles = ["cmdfile", "targets", "science", "scicon.sch", "pdoscmds.bat", "tcm2mat.cal", "sg_calib_constants.m"];
    const cmdfileButtons = ['btnGO', 'btnQUIT', 'btnRESUME'];
    function changeFile() {
        var file = $('selectFile').value;
        for (var f of knownFiles) {
            if (f == file) {
                $(f).removeAttribute('hidden');
                if (controlFileDirty[f])
                    $('btnSubmit').classList.add('fileDirty');
                else
                    $('btnSubmit').classList.remove('fileDirty');
            }
            else
                $(f).setAttribute('hidden', '');
        }

        for (var b of cmdfileButtons) {
            if (file != "cmdfile") 
                $(b).setAttribute('hidden', '');
            else 
                $(b).removeAttribute('hidden');
        }

        if (file in controlFileDive) {
            $('fileDive').innerHTML = '.' + controlFileDive[file];
            $('fileDive').removeAttribute('hidden');
        }
        else {
            $('fileDive').setAttribute('hidden', '');
            $('fileDive').innerHTML = '';
        }
    }
{% endif %}

    function popupImage(ext, which, dive, elt) {
        var m = mission();
        if (m == '')
            m = '?wrap=page';
        else
            m = m + '&wrap=page';

        window.open('plot/' + ext + '/' + which + '/' + currGlider + '/' + dive + '/' + elt + m, `${currGlider}-${dive}-${elt}`);
    }

    function popupSelftest() {
        window.open('selftest/' + currGlider + mission(), currGlider + '-selftest');
    }

    function popupMap() {
        window.open('map/' + currGlider + mission(), currGlider + '-map');
    }

    function popupPosition() {
        window.open('pos/' + currGlider + mission(), currGlider + '-position');
    }

    function gliderIndex() {
        window.open('./?gliders=' + currGlider);
    }

    function openBallastSheet() {
        var opts = ['limit=1'];
        if (mission() != '')
            opts.push(mission()) 

        var q = `query/${currGlider}/dive,log_MASS,log_RHO,log_VBD_MIN,log_VBD_MAX,log_MAX_BUOY,log_C_VBD,log_VBD_CNV${formatQuery(opts)}`

        fetch(q)
        .then(res => res.text())
        .then(text => {
            if (text == "none" || text.includes("authorization failed"))
                return;

            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log('openBallastSheet ' + error);
            }

            if ('error' in data) {
                console.log(data['error']);
                return;
            }

            try {
                let volmax = data['log_MASS']/data['log_RHO'] + (data['log_VBD_MIN'] - data['log_C_VBD'])*data['log_VBD_CNV'];
                window.open(`ballast?mass=${data['log_MASS']}&volmax=${volmax}&density=${data['log_RHO']}&thrust=${-data['log_MAX_BUOY']}&min=${data['log_VBD_MIN']}&max=${data['log_VBD_MAX']}`, currGlider + '-ballast');
            } catch(error) {
                console.log('openBallastSheet ' + error);
            }
        });
    }

    function missionIndex() {
        if (!currMission || currMission == '')
            return;

        if (currStatus == 'active')
            window.open('dash?mission=' + currMission);
        else
            window.open('./?mission=' + currMission);
    }

    function projectIndex() {
        if (!currProject || currProject == '')
            return;

        window.open('./?mission=' + currProject);
    }

    function setVisibility(elt) {
{% if runMode == 'pilot' %}
        const divs = ['mainImage', 'mainDiv', 'mainTable', 'logDiv', 'plotlyDiv', 'logfileDiv', 'notificationsDiv', 'engfileDiv', 'capfileDiv', 'pilotWheelDiv', 'searchToolDiv'];
{% else %}
        const divs = ['mainImage', 'mainDiv', 'mainTable', 'logDiv', 'plotlyDiv', 'logfileDiv', 'notificationsDiv', 'engfileDiv', 'capfileDiv'];
{% endif %}
        const noflowDivs = ['searchToolDiv']; // , 'changelogDiv'];

        for (var d of divs) {
            if (d != elt) $(d).classList.add('hide');
        }
        $(elt).classList.remove('hide');
        $('plotlyPopperOuter').style.display = 'none';
        $('plotlyPermalink').style.display = 'none';
        $('diveIndicator').style.display = 'none';

        if (noflowDivs.includes(elt)) {
            $('main').style.overflow = "hidden";
        }
        else {
            $('main').style.overflow = "auto";
        }

    }

    function showPlotLinks() {
        var list;

        if ($('plotLinksPopup').style.display == 'block') {
            $('plotLinksPopup').style.display = 'none';
            return;
        }

        while($('plotLinksPopup').firstChild) {
            $('plotLinksPopup').removeChild($('plotLinksPopup').firstChild);
        }

        list = document.createElement('ul');
        $('plotLinksPopup').appendChild(list);

        plotList.forEach(function(ln) { 
            it = document.createElement('li');
            it.innerHTML = ln.name;
            it.onclick = function() { showPlot(ln.which, ln.name, ln.plotly); console.log(ln.which + ' ' + ln.name); $('plotLinksPopup').style.display = 'none'; }
            list.appendChild(it);
        });

        $('plotLinksPopup').style.display = 'block';
    }

    function showPlot(which, elt, plotly) {
        console.log('showing ' + elt);
        console.log('plotly available ' + plotly)
        if (!plotly || mobile) {
            setVisibility('mainImage');
            $('mainImage').src = `plot/webp/${which}/${currGlider}/${currDive}/${elt}${mission()}`;
            $('plotlyPopperOuter').style.display = 'block';
            $('diveIndicator').style.display = 'block';
            console.log('popper up');
            if (plotly)
                $('plotlyPopperOuter').onclick = function() 
                    { 
                        popupImage('div', which, currDive, elt); 
                        return false; 
                    } 
            else
                $('plotlyPopperOuter').onclick = function() 
                    { 
                        popupImage('webp', which, currDive, elt); 
                        return false; 
                    } 
        }
        else {
            $('waitIndicator').style.display = 'block';
            setVisibility('mainDiv');
            $('diveIndicator').style.display = 'block';
            $('plotlyPopperOuter').style.display = 'block';
            console.log('popper up');

            fetch(`plot/div/${which}/${currGlider}/${currDive}/${elt}${mission()}`)
            .then(res => res.text())
            .then(data => {
                if (data == "none" || data.includes("authorization failed"))
                    return;

                setInnerHTML($('mainDiv'), data);
                $('plotlyPopperOuter').onclick = function() 
                    { 
                        popupImage('div', which, currDive, elt); 
                        return false; 
                    } 
                $('waitIndicator').style.display = 'none';
            })
            .catch(error => {
                console.log('show plot error'); // error);
                $('waitIndicator').style.display = 'none';
            });
        }
        currElt = elt;
        $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;
        console.log(currElt);
    }

    function addTableRow(d) 
    {
        var row, cell, text;
        var tbody = $('mainTable').getElementsByTagName('tbody')[0];
        const colors = ["#cccccc", "#eeeeee"];
        var i, c;
        var date;
        var course; 
        var dist;
        var n, e;
        var rowID = 'row' + d['dive'];

        if ($(rowID) != null) {
            console.log('row exists ' + rowID);
            $(rowID).remove();
        }
   
        divesInTable.push(d['dive']);
 
        for (const key in d) {
            if (d[key] == null)
                d[key] = 0;
        }
 
        row = tbody.insertRow(1);
        row.id = rowID;
        
        i = $('mainTable').rows.length % 2;
        row.style.backgroundColor = colors[i];
        cell = row.insertCell(0);
       
        if ('criticals' in d &&  d['criticals'] > 0)
            color = 'red';
        else
            color = 'black';

        alerts  = 'alerts'  in d && d['alerts']  > 0 ? '<b title="alerts">a</b>' : '';
        capture = 'capture' in d && d['capture'] > 0 ? `<b title="capture file" style="color:${color}">c</b>` : '';
        changes = 'changes' in d && d['changes'] > 0 ? '<b title="parameter changes">p</b>' : '';
        files   = 'files' in d && d['files'] > 0 ? '<b title="control files">f</b>' : '';
 
        cell.innerHTML = '<a href="#" onclick="loadPlots(' + d['dive'] + ', false);">' + d['dive'] + '</a>' + changes + files + alerts + capture;
        cell.style.textAlign = 'left';
        // cell.appendChild(text);

        // date = new Date(1000*(d['log_start'] + d['total_flight_time_s']));
        date = new Date(1000*(d['log_gps_time']));
        cell = row.insertCell(1); 
        text = document.createTextNode((date.getUTCFullYear() - 2000) + '/' +
                                       (date.getUTCMonth() + 1).zeroPad() + '/' + 
                                       date.getUTCDate().zeroPad() + ' ' + 
                                       date.getUTCHours().zeroPad() + ':' + 
                                       date.getUTCMinutes().zeroPad());
        cell.appendChild(text);

        cell = row.insertCell(2); 
        text = document.createTextNode('' + ((d['log_gps_time'] - d['log_start'])/60).toFixed(0));
        cell.appendChild(text);

        cell = row.insertCell(3);
        text = document.createTextNode('' + d['max_depth'].toFixed(0) + '(' + d['log_D_TGT'] + ')');
        cell.appendChild(text);

        dist = Math.sqrt(d['GPS_north_displacement_m']*d['GPS_north_displacement_m'] 
                         + d['GPS_east_displacement_m']*d['GPS_east_displacement_m']);
        course = Math.atan2(d['GPS_east_displacement_m'], d['GPS_north_displacement_m'])*180.0/Math.PI;
        if (course < 0) {
            course = course + 360;
        }
        cell = row.insertCell(4);
        text = document.createTextNode('' + (dist/1000).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(5);
        text = document.createTextNode('' + course.toFixed(1));
        cell.appendChild(text);

        n = d['flight_avg_speed_north'] * d['time_seconds_diving'];
        e = d['flight_avg_speed_east'] * d['time_seconds_diving'];
        dist = Math.sqrt(n*n + e*e);
        course = Math.atan2(e, n)*180.0/Math.PI;
        if (course < 0) {
            course = course + 360;
        }
        cell = row.insertCell(6);
        text = document.createTextNode('' + (dist/1000).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(7);
        text = document.createTextNode('' + course.toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(8);
        text = document.createTextNode('' + (d['meters_to_target']/1000).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(9);
        text = document.createTextNode('' + (d['mag_heading_to_target'] + d['magnetic_variation']).toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(10);
        text = document.createTextNode('' + d['dog_efficiency'].toFixed(2));
        cell.appendChild(text);

        
        dist = Math.sqrt(d['depth_avg_curr_east']*d['depth_avg_curr_east'] 
                         + d['depth_avg_curr_north']*d['depth_avg_curr_north']);
        course = Math.atan2(d['depth_avg_curr_east'], d['depth_avg_curr_north'])*180.0/Math.PI;
        if (course < 0) {
            course = course + 360;
        }

        cell = row.insertCell(11);
        text = document.createTextNode('' + (dist*100.0).toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(12);
        text = document.createTextNode('' + course.toFixed(1));
        cell.appendChild(text);

        cell = row.insertCell(13);
        text = document.createTextNode('' + d['log_HUMID'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(14);
        text = document.createTextNode('' + d['log_INTERNAL_PRESSURE'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(15);
        cell.classList.add("volt10");
        text = document.createTextNode('' + d['batt_volts_10V'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(16);
        cell.classList.add("volt10");
        text = document.createTextNode('' + (d['batt_capacity_10V']*100).toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(17);
        cell.classList.add("volt24");
        text = document.createTextNode('' + d['batt_volts_24V'].toFixed(2));
        cell.appendChild(text);

        cell = row.insertCell(18);
        cell.classList.add("volt24");
        text = document.createTextNode('' + (d['batt_capacity_24V']*100).toFixed(2));
        cell.appendChild(text);
        
        cell = row.insertCell(19);
        text = document.createTextNode('' + d['error_count'].toFixed(0));
        cell.appendChild(text);
    }

    function buildChangelog(which) {
        var glider = currGlider;
        var q, sort;
        var prev, c, cols;

        console.log("building change table");
  

        const colors = ["#cccccc", "#eeeeee"];
 
        if (which == 1 || which == 3) {
            sort = document.querySelector('input[name="changelogSortParm"]:checked').value;
            console.log(sort);
            q = `changes/${glider}/-1/parms/${sort}${mission()}`

            fetch(q)
            .then(res => res.text())
            .then(text => {
                if (text == "none" || text.includes("authorization failed"))
                    return;

                try {
                    data = JSON.parse(text);
                } catch (error) {
                    console.log('buildChangelog ' + error);
                    console.log(text);
                    return;
                }
       
                console.log(data);
 
                if ('error' in data) {
                    console.log('buildChangelog ' + data['error']);
                    return;
                }

                c = 0;
                if (sort == 'dive') {
                    prev = -1;
                    cols = ['dive', 'parm'];
                }
                else {
                    prev = '';
                    cols = ['parm', 'dive'];
                }
                
                txt = '<table id="changeTable">';
                txt = txt + `<tr><th>${cols[0]}</th><th>${cols[1]}</th><th>old</th><th></th><th>new</th></tr>`;

                for (d of data) {
                    if (d[cols[0]] != prev) 
                        c = !c; // (c == 0 ? 1 : 0);

                    txt += '<tr style="background-color: ' + colors[c] + '";>';

                    console.log(d[cols[0]]);
                    if (d[cols[0]] != prev) {
                        if (cols[0] == 'parm')
                            txt += `<td><a target="parms" href="parms#${d['parm'].slice(1)}">${d['parm']}</a></td>`;
                        else
                            txt += '<td>' + d['dive'] + '</td>';

                        prev = d[cols[0]];
                    }    
                    else 
                        txt += '<td></td>';
                    
                    if (cols[1] == 'parm')
                        txt += `<td><a target="parms" href="parms#${d['parm'].slice(1)}">${d['parm']}</a></td>`;
                    else
                        txt += '<td>' + d['dive'] + '</td>';

                    txt += '<td>' + d['oldval'] + '</td>';
                    txt += '<td><b>&#10230;</b></td>';
                    txt += '<td>' + d['newval'] + '</td></tr>';
                }
                txt += '</table>';
                $('changelogTable').innerHTML = txt;
            })
            .catch(error => {
                console.log(error);
            });
        }
        if (which == 2 || which == 3) {
            sort = document.querySelector('input[name="changelogSortFile"]:checked').value;
            q = `changes/${glider}/-1/files/${sort}${mission()}`

            console.log('building files history');
            fetch(q)
            .then(res => res.text())
            .then(text => {
                var pdl, pdc;

                if (text == "none" || text.includes("authorization failed"))
                    return;

                console.log(text);
                try {
                    data = JSON.parse(text);
                } catch (error) {
                    console.log('buildChangelog ' + error);
                    console.log(text);
                    return;
                }

                if ('error' in data) {
                    console.log('buildChangelog ' + data['error']);
                    return;
                }

                c = 0;
                
                html = '';
                for (d of data) {
                    if (!('used' in d)) {
                        if (d['file'] != 'pdoslog') {
                            html += '<b>' + d['fullname'] + '</b>';
                            html += '<div style="margin-left:40px;"><pre>' + d['contents'] + '</pre></div>';
                            if (d['file'] == 'pdoscmds.bat' && 'cycle' in d) {
                                pdl = data.find(e => e['file'] == 'pdoslog' && e['cycle'] == d['cycle'] && e['dive'] == d['dive']);                            
                                if (pdl && !('used' in pdl)) {
                                    html += '<b>' + pdl['fullname'] + '</b>';
                                    html += '<div style="margin-left:40px;"><pre>' + pdl['contents'] + '</pre></div>';
                                    pdl['used'] = true;
                                }
                            }
                        }
                        else {
                            pdc = data.find(e => e['file'] == 'pdoscmds.bat' && e['cycle'] == d['cycle'] && e['dive'] == d['dive']);
                            if (pdc && !('used' in pdc)) {
                                html += '<b>' + pdc['fullname'] + '</b>';
                                html += '<div style="margin-left:40px;"><pre>' + pdc['contents'] + '</pre></div>';
                                pdc['used'] = true;
                            }
                            html += '<b>' + d['fullname'] + '</b>';
                            html += '<div style="margin-left:40px;"><pre>' + d['contents'] + '</pre></div>';
                        }
                    }
                    d['used'] = true;
                }
                $('changelogFilesContent').innerHTML = html;
            })
            .catch(error => {
                console.log(error);
            });
        } 
    }

    function buildTable(glider, dive) {
        var q;
        console.log("building table");

    
        q = `db/${glider}/${dive}${mission()}`
        if (dive  == -1) {
            clearTable();
        }
 
        fetch(q)
        .then(res => res.text())
        .then(text => {
            if (text == "none" || text.includes("authorization failed"))
                return;

            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log('buildTable ' + error);
                console.log(text);
                return;
            }

            if ('error' in data) {
                console.log('buildTable ' + data['error']);
                return;
            }
        
            var has10 = false;
            var has24 = false;
            for (d of data) {
                addTableRow(d);
                if (d['batt_capacity_24V'] > 0)
                    has24 = true;
                if (d['batt_capacity_10V'] > 0) 
                    has10 = true;
            }
            if (has10 == false) {
                coll = document.getElementsByClassName("volt10");
                for (var i = 0 ; i < coll.length ; i++)
                    coll[i].style.display = "none";
                $('volt24_header').innerHTML = 'volts';
            }
            else if (has24 == false) {
                coll = document.getElementsByClassName("volt24");
                for (var i = 0 ; i < coll.length ; i++)
                    coll[i].style.display = "none";
                $('volt10_header').innerHTML = 'volts';
            }
            if (dive == -1) {
                highlightCurrDive(currDive);
            }
        })
        .catch(error => {
            console.log(error);
        });
    }

    function searchToolFilter() {
        const lines = $('searchToolResults').innerHTML.split("\n");
        var fields, nf, i, j, data;
        var out;

        try {
            fields = $('searchToolFilterFields').value.split(",");
        }
        catch {
            alert('specify comma separated list of fields');
            return;
        }

        if (fields.length < 1) {
            alert('specify comma separated list of fields');
            return;
        }

        for (i = 0 ; i < fields.length ; i++) {
            try {
                fields[i] = parseInt(fields[i]) - 1;
            }
            catch {
                alert('specify comma separated list of fields');
                return;
            }
        }

        console.log(fields);

        out = '';
        for (i = 0 ; i < lines.length ; i++) {
            data = lines[i].split(/[,: ]/);        
            console.log(data);
            for (j = 0 ; j < fields.length ; j++)
                if (fields[j] >= 0 && fields[j] < data.length)
                    out = out + data[fields[j]] + ' ';

            out = out + '\n';
        }    

        $('searchToolResults').innerHTML = out;
    }
    function searchToolPlot(xy) {
        const lines = $('searchToolResults').innerHTML.split("\n");
        var   data, st, nf, i;
        var   xd, d;

        data = []
        for (i = 0 ; i < lines.length ; i++) {
            data.push(lines[i].trim().split(/[,: ]/));        
        }

        data = transpose(data);
        if (xy) {
            xd = data[0];
            st = 1;
        }
        else {
            xd = [...Array(lines.length).keys()];
            st = 0;
        }    

        nf = data.length;
        console.log('nfields ' + nf);

        d = []
        for (i = st ; i < nf ; i++) {
            d.push({
                    x: xd,
                    y: data[i],
                    mode: "markers",
                    type: "scatter",
                   });
        }
        var layout = { 
                        font:   { size: 12 },
                        margin: { t:20, l:80, r:80, b:80 },
                        xaxis:  { title: "" },
                        yaxis:  { title: "", autorange: true },
                        title:  { text: "" },
                        plot_bgcolor: "#cccccc",
                        paper_bgcolor: "#bbbbbb",
                     };
        var config = { responsive: true };
        $('searchToolPlot').removeChild($('searchToolPlot').firstChild);
        Plotly.newPlot($('searchToolPlot'), d, layout, config);
    }
    function searchTool() {
        const whichFile = document.querySelector('input[name="searchToolWhichFiles"]:checked').value;
        const whichDives = document.querySelector('input[name="searchToolWhichDives"]:checked').value;
        const search = $('searchToolTerm').value;
        const filename = $('searchToolIncludeFilename').checked;
        const divenum = $('searchToolIncludeDiveNumber').checked;
        var dive1 = 0, diveN = 0;
        var opts = [];

        if (search == "") {
            return;
        }

        if (whichDives == "range") {
            try {
                dive1 = parseInt($('searchToolFirstDive').value);
            }
            catch (error) {
                console.log(error);
                dive1 = 0;
            }
            try {
                diveN = parseInt($('searchToolLastDive').value);
            }
            catch (error) {
                console.log(error);
                diveN = 0;
            }
        }

        if (mission() != "")
            opts.push(mission());
        if (filename)
            opts.push('showfile=1');
        if (divenum)
            opts.push('showdive=1');

        $('searchStatus').innerHTML = 'processing';
        $('searchStatus').classList.add('processing');
        fetch(`grep/${currGlider}/${whichFile}/${whichDives}/${dive1}/${diveN}/${search}${formatQuery(opts)}`)
        .then(res => res.text())
        .then(text => {
            if (text == "none" || text.includes("authorization failed"))
                return;

            $('searchStatus').innerHTML = '';
            $('searchStatus').classList.remove('processing');
            $('searchToolResults').innerHTML = text;
        });
    }

{% if runMode == 'pilot' %}
    function showPilotWheel() {
        setVisibility('pilotWheelDiv'); 
        currElt = 'pilotWheel';
    }
{% endif %}
    function showSearchTool() {
        setVisibility('searchToolDiv'); 
        currElt = 'searchTool';
    }

    function showTable() {
        setVisibility('mainTable'); 
        currElt = 'table';
        $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;
    }

    function showPlotly() {
        setVisibility('plotlyDiv');
    }

    function showLog() {
        setVisibility('logDiv');
        currElt = 'logfile';
        $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;
        $('diveIndicator').style.display = 'block';
    }

    function showLogFile() {
        setVisibility('logfileDiv');
        currElt = 'logfileRaw';
        $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;
        $('diveIndicator').style.display = 'block';
    }

    function showEng() {
        setVisibility('engfileDiv');
        currElt = 'engfile';
        $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;
        $('diveIndicator').style.display = 'block';
    }

    var critLine = null;
    function showCap() {
        setVisibility('capfileDiv');
        $('diveIndicator').style.display = 'block';
        currElt = 'capfile';
        $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;
        if (critLine !== null)
            $(critLine).scrollIntoView({ block: "center" });
    }

    function showNotifications() {
        setVisibility('notificationsDiv');
        $('diveIndicator').style.display = 'block';
        currElt = 'notifications';
        $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;
        if ($('btnNotifications').innerHTML != "") {
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-active-icon.png')";
            $('btnNotifications').innerHTML = '';
            console.log('clearing alert blink');
        }
    }

//    function showChangelog() {
//        setVisibility('changelogDiv');
//        currElt = 'changelog';
//        $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;
//    }

    function loadAbout(mission, org) {
        var cell, t, tbody, row;

        d = $('aboutContent');
        t = document.createElement('table');
        d.appendChild(t);
        tbody = document.createElement('tbody');
        t.appendChild(tbody);

        for (k of Object.keys(mission)) {
            if (mission[k] == null)
                continue;

            row = tbody.insertRow();
            cell = row.insertCell(0);
            cell.innerHTML = k + ':';
            cell.style = "text-align:right;"
            cell = row.insertCell(1);
            if (k.includes('link'))
                cell.innerHTML = '<a href="' + mission[k] + '">' + mission[k] + '</a>';
            else
                cell.innerHTML = mission[k];
        } 
    }

{% if runMode == 'pilot' %}

    function changeEditlog(which) {
        const panes = ["Cmdedit", "Sciedit", "Targedit"];
        for (p of panes) {
            if (p != which) {
                $('pilot' + p).classList.add('hide');
                $('tab' + p).classList.remove('bold');
            }
        }
        $('pilot' + which).classList.remove('hide');
        $('tab' + which).classList.add('bold');
    }

    function changeWheelPane(file) {
        const panes = ["Trim", "Cmdfile", "Science", "Targets", "Logs", "History"];
        for (p of panes) {
            if (file != p) {
                $('pilotWheel' + p).classList.add('hide');
                $('tab' + p).classList.remove('bold');
            }
        }
        $('pilotWheel' + file).classList.remove('hide');
        $('tab' + file).classList.add('bold');

        if (file == 'Logs' && edit_log_auth_failure) {
            openLoginForm(function() { loggedIn(); loadEditlog('cmdedit'); loadEditlog('targedit'); loadEditlog('sciedit');  }, "");
        }
    }

    /* TARGETS EDITOR */

    const targetKeys = ["lat", "lon", "radius", "goto", "depth", "finish", "head", "dives", "timeout", "timeout-goto", "exec", "timeout-exec", "timeout-goto", "fence-lat", "fence-lon", "fence-radius", "fence-exec", "fence-goto"];

    function initTargetsEntryTable()
    {
        var tr, td, inp;
        
        for (k of targetKeys) {
            tr = document.createElement('tr');
            td = document.createElement('td');
            td.innerHTML = k;
            tr.appendChild(td);

            td = document.createElement('td');
            inp = document.createElement('input');
            inp.id = 'targets' + k;
            td.appendChild(inp);
            tr.appendChild(td);
            $('targetsEntryTable').appendChild(tr);             
        }
    }

    function targetToString(t) 
    {
        var str = t.name;

        for (k of targetKeys) {    
            if (k in t) {
                str = str + ' ' + k + '=' + t[k];
            }
        }

        return str;
    }

    function rowToTarget(r)
    {
        var cols = r.cells;
        var flds = cols[2].innerHTML.split(' ');
        var t    = {};

        t['name'] = cols[1].innerHTML;
        for (var i = 0 ; i < flds.length ; i++) {
            s = flds[i].split('=');
            t[s[0]] = s[1]; 
        }

        return t;
    }

    function findTargetByName(name)
    {
        for (var i = 0 ; i < $('targetsList').rows.length ; i++) {
            if (name == $('targetsList').rows[i].cells[1].innerHTML)
                return i;
        }
    
        return -1; 
    }

    function addUpdateTarget()
    {
        var i = findTargetByName($('targetsname').value);
        var t = {};

        t['name'] = $('targetsname').value;
        for (k of targetKeys) {
            if ($('targets' + k).value != '') {
                t[k] = $('targets' + k).value;
            }
        } 

        if (i == -1)  {
            addTargetToList(t, -1);
            highlightTargetRowByIndex($('targetsList').rows.length - 1);
        }
        else {
            var str = targetToString(t);
            $('targetsList').rows[i].cells[2].innerHTML = str.split(' ').slice(1).join(' '); 
        }
    }

    function getSelectedTargetRowIndex()
    {
        for (var i = 0 ; i < $('targetsList').rows.length ; i++) {
            if ($('targetsList').rows[i].classList.contains('selected-target')) 
                return i;
        }

        return -1;
    }

    function copySelectedTarget() 
    {
        var t, i;
        i = getSelectedTargetRowIndex();
        if (i >= 0) {
            var t = rowToTarget($('targetsList').rows[i]);
            t['name'] = t['name'] + '_copy';
            addTargetToList(t, -1);
        }
    }

    function sendTargetsToMap()
    {
        var tgts = [];
        for (var i = 0 ; i < $('targetsList').rows.length ; i++) {
            tgts.push(rowToTarget($('targetsList').rows[i]));
        }

        targetsChannel.postMessage(tgts);
    }

    function insertTargets()
    {
        var ninsert = 2;
        var t1, t2;
        var isel = getSelectedTargetRowIndex();
        var pts = [], pt;
        var rng, brg;
        var radius;
        if (isel < 1)
            return;
   
        t2 = rowToTarget($('targetsList').rows[isel]); 
        t1 = rowToTarget($('targetsList').rows[isel - 1]); 

        if ($('intermediateRadius').value != '')
            radius = $('intermediateRadius').value;
        else
            radius = t2['radius'];

        try {
            ninsert = parseInt($('intermediateCount').value);
        }
        catch {
            ninsert = 2;
        }

        rng = haversine({ lat: ddmm2dd(parseFloat(t1.lat)), lon: ddmm2dd(parseFloat(t1.lon)) },
                        { lat: ddmm2dd(parseFloat(t2.lat)), lon: ddmm2dd(parseFloat(t2.lon)) });
        console.log(rng);
        rng = rng / (ninsert + 1);
        brg = bearing({ lat: ddmm2dd(parseFloat(t1.lat)), lon: ddmm2dd(parseFloat(t1.lon)) },
                      { lat: ddmm2dd(parseFloat(t2.lat)), lon: ddmm2dd(parseFloat(t2.lon)) });
        console.log(brg);
 
        for (var i = 0 ; i < ninsert ; i++) {
            var t = { name: t1['name'] + '_' + t2['name'] + '_' + (i+1) };
            pt = reckon([ddmm2dd(parseFloat(t1.lat)), ddmm2dd(parseFloat(t1.lon))], rng*(i + 1), brg);
            console.log(pt);
            t['lat'] = dd2ddmm(pt[0]).toFixed(3);
            t['lon'] = dd2ddmm(pt[1]).toFixed(3);
            if (i < ninsert - 1)
                t['goto'] = t1['name'] + '_' + t2['name'] + '_' + (i+2);
            else
                t['goto'] = t2['name'];
            t['radius'] = radius;
            console.log('adding at ' + (isel + i));
            addTargetToList(t, isel + i);
        }

        t1['goto'] = t1['name'] + '_' + t2['name'] + '_1';
        $('targetsList').rows[isel-1].cells[2].innerHTML = targetToString(t1).split(' ').slice(1).join(' '); 
    }

    function writeTargetsFile()
    {
        var str = '';
        var t;
        for (var i = 0 ; i < $('targetsList').rows.length ; i++) {
            t = rowToTarget($('targetsList').rows[i]);
            str = str + targetToString(t) + '\n';
        }
        $('selectFile').value = 'targets';
        changeFile();
        $('targets').value = str;  
        controlFileMarkDirty('targets');
    }

    function getTargetsFromMap(pts) 
    {
        if (pts == null || pts.length == 0) {
            return;
        }

        clearTargetsList();
        for (var i = 0 ; i < pts.length ; i++) {
            var t = {};
            t['name'] = 'T' + (i+1);
            if (i < pts.length - 1)
                t['goto'] = 'T' + (i+2);
            else 
                t['goto'] = t['name'];
            t['lat'] = dd2ddmm(pts[i].lat).toFixed(3);
            t['lon'] = dd2ddmm(pts[i].lng).toFixed(3);
            t['radius'] = 2000;
            addTargetToList(t, -1);
        }
        highlightTargetRowByIndex(0);
    }

    function loadTargetToForm(t)
    {
        $('targetsname').value = t['name'];
        for (k of targetKeys) {
            $('targets' + k).value = k in t ? t[k] : '';
        }
    }

    function toggleSelectedTargetRow(r) 
    {
        var rows = $('targetsList').rows;
        var nr = rows.length;

        for (var i = 0 ; i < nr ; i++) {
            if (rows[i] == r) {
                rows[i].classList.add('selected-target');
                loadTargetToForm(rowToTarget(rows[i]));
            }
            else {
                rows[i].classList.remove('selected-target');
            }
        }
    }

    function highlightTargetRowByIndex(i)
    {
        if (i >= $('targetsList').rows.length)
            i = 0;
            
        if ($('targetsList').rows.length > 0)
            toggleSelectedTargetRow($('targetsList').rows[i]); 
    }

    function addTargetToList(t, idx)
    {
        var tr, del, nm, bdy, str;
        str = targetToString(t);
        
        
        tr  = $('targetsList').insertRow(idx); // document.createElement('tr');
        bdy = document.createElement('td');
        nm  = document.createElement('td');
        del = document.createElement('td');
        del.innerHTML = 'x';
        del.addEventListener("click", function() { deleteTargetRow(this); });
        tr.appendChild(del);
        tr.addEventListener("click", function() { toggleSelectedTargetRow(this); });
        nm.innerHTML = str.split(' ')[0];
        bdy.innerHTML = str.split(' ').slice(1).join(' ');
        tr.appendChild(nm);
        tr.appendChild(bdy); 
    }

    function deleteTargetRow(d)
    {
        var idx = d.parentNode.rowIndex;
        $('targetsList').deleteRow(idx);
        highlightTargetRowByIndex(idx - 1);
    }

    function clearTargetsList()
    {
        var nr = $('targetsList').rows.length;
        for (var i = nr-1 ; i >= 0 ; i--)
            deleteTargetRow($('targetsList').rows[i]);

        $('targetsname').value = '';
        for (k of targetKeys) {
            $('targets' + k).value = '';
        }
    }

    function loadTargetsList(tgts) 
    {
        clearTargetsList();
        for (t of tgts) {
            addTargetToList(t, -1);
        }
        highlightTargetRowByIndex(0);
    }

    /* SCIENCE EDITOR */

    function createInput(value, classname)
    {
        var inp = document.createElement('input');
        inp.setAttribute("type", "text");
        inp.setAttribute("size", "4");
        inp.value = value;
        inp.className = classname;

        return inp;
    }

    function initScienceFileTable(d)
    {
        var i, nameToUse;
        if (d) {
            for (i = 0 ; i < d.length ; i++) {
                addScienceFileRow(structuredClone(d[i]));
            }
            updateScienceFileTable();
        }
        else {
            addScienceFileRow({ name: '50', seconds: '5', gc: '300', sensors: new Array('1', '1', '1', '0', '0', '0')});
        }
        
        if (parms_SENSORS) {
            
            for (i = 1 ; i <= 6 && i <= parms_SENSORS.length ; i++) {
                nameToUse = parms_SENSORS[i-1] != 'nil' ? parms_SENSORS[i-1] : 'sensor' + i; 
                $('scienceSensor' + i).innerHTML   = nameToUse;
                $('scienceProfiles' + i).innerHTML = nameToUse;
                $('scienceDives' + i).innerHTML    = nameToUse;
            } 
        } 
    }

    function updateScienceFileTable()
    {
        var i, nr, td, td_prev;
        var rows = $('scienceTable').getElementsByTagName("TR"); 
        nr = rows.length;
        for (i = 1 ; i < nr ; i++) {
            td_prev = rows[i-1].getElementsByClassName("depth")[0];
            td = rows[i].childNodes[1].childNodes[0];
            td.nodeValue =  td_prev.value + " - ";
        }
    }

    function changeScienceFileIncrement(row)
    {
        var i;
        var spin;
        var wake = parseFloat(row.getElementsByClassName("wake")[0].value);
        var incr, mult;
        for (i = 0 ; i < 8 ; i++) {
            spin = row.getElementsByClassName("spinContainer")[i].spin;
            incr = spin.GetIncrement();
            mult = spin.GetCurrentValue() / incr;
            spin.SetIncrement(wake);
            spin.SetCurrentValue(wake*mult);
        } 
    }

    function deleteScienceFileRow(row) {
        if (row.rowIndex <= 2)
            return;

        $('scienceTable').parentNode.deleteRow(row.rowIndex);
        updateScienceFileTable();

    }

    function parseScienceFileRow(row) {
       var ons, wake, depth, gc, spin, compass, pressure;
       var profiles = null, dives = null, timeout = null, batch = null;
       var mult;
       var j;

       ons = new Array();
       dives = new Array();
       profiles = new Array();
       wake = row.getElementsByClassName("wake")[0].value;
       gc = row.getElementsByClassName("gc")[0].value;
       depth = row.getElementsByClassName("depth")[0].value;
       for (j = 0 ; j < 6 ; j++) {
           spin = row.getElementsByClassName("sensorSpin" + j)[0].spin; 
           mult = spin.GetCurrentValue() / spin.GetIncrement();
           ons.push(mult);

           spin = row.getElementsByClassName("divesSpin" + j)[0].spin; 
           mult = spin.GetCurrentValue() / spin.GetIncrement();
           dives.push(mult);

           mult = row.getElementsByClassName("selProfiles" + j)[0].value;
           profiles.push(mult);
       }

       spin = row.getElementsByClassName("sensorSpin" + 6)[0].spin; 
       compass = '' + spin.GetCurrentValue() / spin.GetIncrement();

       spin = row.getElementsByClassName("sensorSpin" + 7)[0].spin; 
       pressure = '' + spin.GetCurrentValue() / spin.GetIncrement();

       timeout = row.getElementsByClassName("timeout")[0].value;

       return {seconds: wake, gc: gc, name: depth, sensors : ons, compass : compass, pressure : pressure, profiles: profiles, dives: dives, timeout: timeout };

    }


    function addScienceFileRow(d) {
        var wake = 'seconds' in d ? d['seconds'] : '5';
        var ons  = 'sensors' in d ? d['sensors'] : [ '1', '1', '1', '0', '0', '0' ];
        var tbody = $('scienceTable');
        var row = document.createElement("TR")
        var td_depth, td_wake, td_gc, td_top, txt, inp, td_img, img, td, sel, opt;
        var tds = new Array();
        var spin;
        var i, j, vopt;
        const profileNames = ["D+C", "D", "C"];
        const profileValues = [3, 1, 2];

        if (ons.length < 6) {
            for (i = ons.length ; i < 6 ; i++)
                ons[i] = '0';
        }

        ons[6] = 'compass' in d ? d['compass'] : '1';
        ons[7] = 'pressure' in d ? d['pressure'] : '1';

        td_img = document.createElement("TD");
        img = document.createElement('span');
        img.innerHTML = '&#10006;';
        img.classList.add('spanClick');
        img.onclick = function() { deleteScienceFileRow(row); }
        td_img.appendChild(img);
        row.appendChild(td_img);

        td_top = document.createElement("TD");
        td_top.appendChild(document.createTextNode("0 - "));
        row.appendChild(td_top);

        td_depth = document.createElement("TD");
        inp = createInput('name' in d ? d['name'] : 100, "depth");
        inp.onchange = updateScienceFileTable;
        td_depth.appendChild(inp);
        row.appendChild(td_depth);

        td_wake = document.createElement("TD");
        inp = createInput(wake, "wake");
        inp.onchange = function() { changeScienceFileIncrement(row); }
        td_wake.appendChild(inp);
        row.appendChild(td_wake);

        for (i = 0 ; i < 8 ; i++) { // 7 and 8 are compass and pressure
            tds[i] = document.createElement("TD");
            spin = new SpinControl();
            tds[i].appendChild(spin.GetContainer());
            spin.GetContainer().classList.add('sensorSpin' + i);
            spin.SetIncrement(parseFloat(wake));
            spin.SetCurrentValue(parseFloat(wake) * parseFloat(ons[i]));
            spin.StartListening();
            row.appendChild(tds[i]);
        }

        td_gc = document.createElement("TD");
        td_gc.appendChild(createInput(d['gc'], "gc"));
        row.appendChild(td_gc);

        td = document.createElement("TD");
        td.appendChild(createInput('timeout' in d ? d['timeout'] : '', "timeout"));
        row.appendChild(td);

        for (i = 0 ; i < 6 ; i++) { 
            td = document.createElement("TD");
            sel = document.createElement('select');
            sel.classList.add('select-checkbox');
            sel.classList.add('select-no-arrow');
            sel.classList.add('selProfiles' + i);
            sel.multiple = false;
 
            
            if ('profiles' in d && i < d['profiles'].length)
                vopt = profileValues.indexOf(parseInt(d['profiles'][i]));
            else
                vopt = 0;
            for (j = 0 ; j < 3; j++) {
                opt = document.createElement('option');
                opt.innerHTML = profileNames[j];
                opt.value = profileValues[j];
                
                if (j == vopt) 
                    opt.selected = true;

                sel.appendChild(opt);
            }

            td.appendChild(sel);
            row.appendChild(td);
        }
        for (i = 0 ; i < 6 ; i++) { 
            td = document.createElement("TD");
            spin = new SpinControl();
            td.appendChild(spin.GetContainer());
            spin.GetContainer().classList.add('divesSpin' + i);
            spin.SetMinValue(0);
            spin.SetMaxValue(100);
            spin.SetIncrement(1);
            if ('dives' in d && i <  d['dives'].length)
                spin.SetCurrentValue(parseInt(d['dives'][i]));
            else
                spin.SetCurrentValue(1);
            spin.StartListening();
            row.appendChild(td);
        }

        tbody.appendChild(row);

    }

    function addNewScienceFileRow() {
       var rows = $('scienceTable').getElementsByTagName("TR");
       var nr = rows.length;
       var line;   
    
       line = parseScienceFileRow(rows[nr - 1]);
       line.name = '' + (parseFloat(line.name) + 100)
       addScienceFileRow(line);
       updateScienceFileTable();

    }

    function writeScienceFileToEditor()
    {
        var today = new Date();
        var spin, incr, mult;
        var str;
        var i, j, nr;
        var rows = $('scienceTable').getElementsByTagName("TR");
        var line;

        str = "/ science file created by online sciedit\n";
        str = str + '/ ' + today.toLocaleString() + '\n';
        str = str + '/ ';

        if (parms_SENSORS) {
            for (i = 0 ; i < parms_SENSORS.length && i < 6 ; i++) {
                str = str + parms_SENSORS[i];
                if (i < parms_SENSORS.length - 1)
                    str = str + ', ';
                else
                    str = str + '\n';
            }
        } 
        nr = rows.length;
        for (i = 0 ; i < nr ; i++) {
            line = parseScienceFileRow(rows[i]);
            str = str + `${line.name} seconds=${line.seconds} sensors=${line.sensors.join('')} gc=${line.gc} pressure=${line.pressure} compass=${line.compass}`; 
            if ('profiles' in line && line.profiles) {
                str = str + ` profiles=${line.profiles.join('')}`
            }
            if ('dives' in line && line.dives) {
                str = str + ` dives=${line.dives.join('')}`
            }
            if ('timeout' in line && line.timeout) {
                str = str + ` timeout=${line.timeout}`
            }
            if ('batch' in line && line.batch) {
                str = str + ` batch=${line.batch}`
            }
            str = str + '\n';
        } 
        $('selectFile').value = 'science';
        changeFile();
        $('science').value = str;  
        controlFileMarkDirty('science');
   }

    const directives = ['GO', 'RESUME', 'QUIT'];
      
    // wholeFile arg is unused
    function updateParmsFromCmdfile(wholeFile) {
        const re = /\$([A-Z][A-Z0-9_]+),([+-]?([0-9]*[.])?[0-9]+)$/;
        let text = $('cmdfile').value.trim().split('\n');
        var pcs;
       
        for (line of text) {
            line = line.trim();
            if (line.slice(0,1) == '$' && directives.includes(line.slice(1))) {
                $('radPilotDirective' + line.slice(1)).checked = true;
            }
            else if ((pcs = re.exec(line)) && pcs.length >= 3) {
                if ($('paramInput_' + pcs[1])) {
                    markChanged(pcs[1]);
                    $('paramInput_' + pcs[1]).value = pcs[2];
                    if (wholeFile) {     // wholeFile flag is set when loading a cmdfile from basestation, so update waiting value
                        parms[pcs[1]]['waiting'] = parseFloat(pcs[2]);
                        $('paramInput_' + pcs[1]).title = makeParmHint(parms[pcs[1]]);
                    }
                }
                else {
                    console.log('no input found for ' + pcs[1]);
                }
            }
        }

        checkLinkedChanges();
    }
 
    function updateCmdfileFromParm(p) {
        const re = /\$([A-Z][A-Z0-9_]+),([+-]?([0-9]*[.])?[0-9]+)$/;
        let text = $('cmdfile').value.trim().split('\n');
        var pcs;
        var newtext = [];
        var directive = '';
        var matched = false;
       
        console.log('orig');
        console.log(text);
 
        for (line of text) {
            line = line.trim();
            if (line.slice(0,1) == '$' && directives.includes(line.slice(1))) {
                directive = line;
            }
            else if ((pcs  = re.exec(line)) && pcs[1] == p) {
                if ($('paramInput_' + p) && floatRE.test($('paramInput_' + p).value.trim())) {
                    newtext.push('$' + p + ',' +  $('paramInput_' + p).value);
                }
                else {
                    newtext.push(line);
                }
                matched = true;
            }
            else if (line.length > 0) {
                newtext.push(line);
            }
        }

        if (!matched && $('paramInput_' + p)) {
            newtext.push('$' + p + ',' +  $('paramInput_' + p).value);
        }

        newtext.push(directive);
        console.log('new');
        console.log(newtext);
        controlFileMarkDirty('cmdfile');
        $('cmdfile').value = newtext.join('\n');
    }

    /* CMDFILE EDITOR */

    var parmGroups = ["BASIC", "NAV", "DIVE", "SURFACE", "FLIGHT", "PITCH", "ROLL", "VBD", "ALTIMETER", "POWER", "HARDWARE"];
    function changeParmGroup(group) {
        for (g of parmGroups) {
            console.log(g);
            if (g != group) {
                $('pilot' + g).classList.add('hide');
                $('tab' + g).classList.remove('bold');
            }
        }
        $('pilot' + group).classList.remove('hide');
        $('tab' + group).classList.add('bold');
    }
    function highlightParam(p) {
        var el = document.querySelectorAll('.paramInputLabel');
        var txt = '';
        console.log('highlighting ' + p);
        for (e of el) {
            if (e.innerHTML.includes('>' + p + '<')) {
                e.style.fontWeight = 'bold';
                changeParmGroup(parms[p]['category']);
                e.classList.add('paramSearched');
            }
            else if (e.style.fontWeight == 'bold') {
                e.style.fontWeight = 'normal'; 
                e.classList.remove('paramSearched');
            } 
        }
        
    }
    function clearParamSearch() {
        $('txtParamSearch').value = '';
        $('divParamSearchResults').innerHTML = '';
        highlightParam('none'); 
    }
    function doParamSearch() {
        var s = $('txtParamSearch').value;
        var s_upper = s.toUpperCase();
        
        var results = ''
        for (p of Object.keys(parms)) {
            if (p.includes(s_upper) || parms[p]['help'].toUpperCase().includes(s_upper)) {
                results = results + '<span class="spanClick" onclick="highlightParam(\'' + p + '\'); return false;">$' + p + '</span>: ' + parms[p]['help'] + '<br>';
            } 
        }

        if (results == '')
            results = 'not found';

        $('divParamSearchResults').innerHTML = results; 
    }
    function markChanged(w) {
        // $('paramInput_' + w).title = 'was ' + $('paramInput_' + w).value;
        if ($('paramInput_' + w))
            $('paramInput_' + w).style.fontWeight = "bold";
        else
            console.log(w + ' not found to mark change');
    }

    const floatRE = /[+-]?([0-9]*[.])?[0-9]+$/;

    function checkLinkedChanges() {
        var t = parseFloat($('paramInput_T_DIVE').value);
        var d = parseFloat($('paramInput_D_TGT').value);
        if (t && d && floatRE.test($('paramInput_T_DIVE').value) && floatRE.test($('paramInput_D_TGT').value)) {
            var w = 2*d*100/(t*60);
            $('pilotVertVelResult').innerHTML = 'w=' + w.toFixed(1) + ' cm/s';
        }
    }
    function pilotVertVel(w) {

        var d = parseFloat($('paramInput_D_TGT').value);
        var t = 2*d*100/60/w;
        if (!d || !t || !floatRE.test($('paramInput_D_TGT').value))
            return;

        markChanged('T_DIVE');
        $('paramInput_T_DIVE').value = t.toFixed(0);
        // parms['T_DIVE']['current'] = parseFloat($('paramInput_T_DIVE').value);
        updateCmdfileFromParm('T_DIVE');

        markChanged('T_MISSION');
        $('paramInput_T_MISSION').value = (t + (0.25*t > 15 ? 0.25*t : 15)).toFixed(0);
        // parms['T_MISSION']['current'] = parseFloat($('paramInput_T_MISSION').value);
        updateCmdfileFromParm('T_MISSION');

        if (parseFloat($('paramInput_D_ABORT').value) < d + 10) {
            markChanged('D_ABORT');
            $('paramInput_D_ABORT').value = (d + 25).toFixed(0);
            // parms['D_ABORT']['current'] = parseFloat($('paramInput_D_ABORT').value);
            updateCmdfileFromParm('D_ABORT');
        }

        checkLinkedChanges();
    }

    function paramInputChange(w) {
        // var prev = parms[w]['current'];
        markChanged(w);
        // parms[w]['current'] = parseFloat($('paramInput_' + w).value);
        updateCmdfileFromParm(w);

        checkLinkedChanges();

    }
    function addParamInput(g, p, hint, v, h, b, m) {
        const colors = ["#cccccc", "#eeeeee"];
        var div = document.createElement('div');
        div.classList.add('paramInputDiv');
        var span = document.createElement('span');
        span.classList.add('paramInputLabel');
        span.innerHTML = `<a target="parms" href="parms#${p}">${p}</a>`;
        span.title = h;
        var inp = document.createElement('input');
        inp.id = 'paramInput_' + p;
        inp.classList.add('paramInputInput');
        inp.value = v;
        inp.title = hint;
        div.appendChild(span);
        var holder = document.createElement('div');
        holder.classList.add('paramInputHolder');
        div.appendChild(holder);
        holder.appendChild(inp); 

        inp.onchange = function() { paramInputChange(p); };
        if (b || m) {
            inp.disabled = true;
            var d2 = document.createElement('div');
            d2.classList.add("clickdown")
            var s2 = document.createElement('label');
            s2.innerHTML = '&#9998;';
            s2.setAttribute('for', 'chk' + p);
            var chk2 = document.createElement('input');
            chk2.type = 'checkbox';
            chk2.id = 'chk' + p;
            d2.appendChild(s2);
            d2.appendChild(chk2);
            var d3 = document.createElement('div')     
            d3.classList.add('clickdown-content');
            d2.appendChild(d3);
                
            var sel = document.createElement('select');
            sel.classList.add('select-checkbox');
            sel.multiple = true;
            d3.appendChild(sel);
 
            var s;
            var n = 0;
            var opts = b ? b : m;
            for (opt of opts) {
                
                s = document.createElement('option');
                s.innerHTML = `${opt['value']}: ${opt['function']}`;
                s.value = opt['value'];
                if ((b && (v & opt['value'])) || (m && v == opt['value']))
                    s.selected = true;

                sel.appendChild(s);
                n ++;
            }
            sel.onchange = function() { 
                var x = 0;
                markChanged(p);
                for (var i = 0 ; i < sel.options.length ; i++) {
                    if (sel.options[i].selected)
                        x += parseInt(sel.options[i].value);
                }
                if (b) inp.value = '' + x;
                else inp.value = x;
                updateCmdfileFromParam(p);
            };
            sel.size = n;
            if (b) multiSelectWithoutCtrl(sel);
            holder.appendChild(d2);
        }

        $(g).appendChild(div);
        div.style.backgroundColor = colors[$(g).childElementCount % 2];
    }

    function makeParmHint(p) {
        hint = '';
        if ('current' in p)
            hint += `on glider: ${p['current']}  `;
        if ('waiting' in p)
            hint += `waiting on basestation: ${p['waiting']}`;
        return hint;
    }

    function loadParms(glider) {
        fetch(`parmdata/${glider}/${maxDive}${mission()}`)
        .then(res => res.text())
        .then(text => {
            if (text == "none" || text.includes("authorization failed"))
                return;

            try {
                parms = JSON.parse(text);
            } catch (error) {
                console.log('loadParms error');
                return;
            }

            // console.log(parms);
            const order = { "DIVE": [ "D_TGT", "T_DIVE", "T_MISSION", "D_ABORT", "N_DIVES"],
                            "NAV": [ "COMPASS_USE", "NAV_MODE", "HEADING", "T_GPS", "N_GPS" ],
                            "SURFACE": [ "SM_CC", "N_NOCOMM", "NOCOMM_ACTION", "T_RSLEEP", "CAPUPLOAD", "COMM_SEQ", "CALL_NIVES", "N_FILEKB", "PROTOCOL", "CALL_TRIES", "CALL_WAIT" ],
                            "VBD":  ["C_VBD", "C_VBD_AUTO_DELTA", "C_VBD_AUTO_MAX", "W_ADJ_DBAND", "VBD_TIMEOUT"],
                            "ROLL": ["C_ROLL_DIVE", "C_ROLL_CLIMB", "ROLL_ADJ_GAIN", "ROLL_ADJ_DBAND", "ROLL_TIMEOUT" ],
                            "PITCH": ["C_PITCH", "PITCH_GAIN", "PITCH_ADJ_GAIN", "PITCH_ADJ_DBAND", "PITCH_W_GAIN", "PITCH_W_DBAND", "C_PITCH_AUTO_DELTA", "C_PITCH_AUTO_MAX", "PITCH_GAIN_AUTO_DELTA", "PITCH_GAIN_AUTO_MAX", "PITCH_TIMEOUT"],
                            "FLIGHT": ["MAX_BUOY", "HEAD_ERRBAND", "RHO", "MASS", ],
                            "ALTIMETER": ["XPDR_INT", "XPDR_REP", "XPDR_VALID", "XPDR_INHIBIT"],
                            "POWER": ["MAXI_10V"],
                            "HARDWARE": ["LOGGERS"],
                        };
            const ignore = ["DIVE", "MISSION", "ID", "DEEPGLIDER", "DEEPGLIDERMB", "MOTHERBOARD"];

            if ('SENSORS' in parms) {
                parms_SENSORS = [...parms['SENSORS']];
                delete parms['SENSORS'];
            }
            if ('TGT_NAME' in parms) {
                parms_TGT_NAME = parms['TGT_NAME'];
                delete parms['TGT_NAME'];
            }

            for (p of Object.keys(parms)) {
                if ('current' in parms[p])
                    parms[p]['original'] =  parms[p]['current'];
                else    
                    parms[p]['original'] = null;
            }

            var hint;
            for (g of Object.keys(order)) {

                for (p of order[g]) {
                    if (Object.keys(parms).includes(p))  
                        addParamInput('pilot' + g, p, makeParmHint(parms[p]), 'current' in parms[p] ? parms[p]['current'] : '', parms[p]['help'], 'bitfield' in parms[p] ? parms[p]['bitfield'] : null, 'menufield' in parms[p] ? parms[p]['menufield'] : null);
                }
            }
            for (p of Object.keys(parms)) {
                if (ignore.includes(p))
                    continue;

                if (parmGroups.includes(parms[p]['category'])) {
                    if (!(Object.keys(order).includes(parms[p]['category'])) ||
                        !(order[parms[p]['category']].includes(p)))
                            addParamInput('pilot' + parms[p]['category'], p, makeParmHint(parms[p]), 'current' in parms[p] ? parms[p]['current'] : '', parms[p]['help'], 'bitfield' in parms[p] ? parms[p]['bitfield'] : null, 'menufield' in parms[p] ? parms[p]['menufield'] : null);
                }
            }
            for (p of Object.keys(parms)) {
                if ('waiting' in parms[p]) {
                    // parms[p]['current'] = parms[p]['waiting']; 
                    markChanged(p);
                    $('paramInput_' + p).value = parms[p]['waiting'];
                }
            }
parms[p]
            loadControlFile('cmdfile');
            loadControlFile('science');
            loadControlFile('targets');

            // initScienceFileTable();
        }); 
    }
{% endif %}
    var indicators = [ { name: 'humidity',         entries: [ 'RH' ],    link: function() { showPlot('eng', 'mission_int_sensors', true); } },
                       { name: 'internalPressure', entries: [ 'intP' ],  link: function() { showPlot('eng', 'mission_int_sensors', true); } },
                       { name: 'depth',            entries: [ 'depth' ], link: function() { showPlot('eng', 'mission_depthangle', true); } },
                       { name: 'pitch',            entries: [ 'pitch' ], link: function() { showPlot('eng', 'mission_depthangle', true); } },
                       { name: 'comms',            entries: [ 'call' ],  link: function() { showPlot('eng', 'download_stats', true); } },
                       { name: 'volts',            entries: [ 'volts' ], link: function() { showPlot('eng', 'mission_energy', true); } },
                       { name: 'errors',           entries: [],          link: showLog },
                       { name: 'alerts',           entries: [],          link: showNotifications },
                       { name: 'OGefficiency',     entries: [],          link: function() { showPlot('dv', 'ctw', true); } },
                       { name: 'VBDefficiency',    entries: [],          link: function() { showPlot('eng', 'vbd_effic', true); } },
                       { name: 'endurance',        entries: [],          link: function() { showPlot('eng', 'mission_energy', true); } },
                       { name: 'volmax',           entries: [],          link: function() { showPlot('eng', 'mission_volmax', true); } } ];
 
                
    function loadAnnunciators(glider) {
        fetch(`summary/${glider}${mission()}`)
        .then(res => res.text())
        .then(text => {
            try {
                text = text.replaceAll('NaN', 'null');
                data = JSON.parse(text);
            } catch (error) {
                console.log('loadAnnunciators ' + error);
                console.log(text);
                return;
            }

            let { element, divs, reds, yellows } = makeAnnunciators(data, mobile ? 5 : 9);
            $('annunciators').innerHTML = '';
            $('annunciators').appendChild(element);
            for (var x of indicators) {
                for (var j = 0 ; j < x.entries.length ; j++) {
                    if (reds.includes(x.name)) {
                        $(x.entries[j]).classList.add('indicatorRed');
                    }
                    else if (yellows.includes(x.name)) {
                        $(x.entries[j]).classList.add('indicatorYellow');
                    }
                }
                if (x.link && $('annunc_' + x.name)) {
                    $('annunc_' + x.name).onclick = x.link;
                } 
            } 
        });
    } 

    
    function loggedIn() {
        $('LoginLogout').innerHTML = ' Logout ';
    }
    function loggedOut() {
        $('LoginLogout').innerHTML = ' Login ';
    }
    function checkUser() {
        fetch('user')
        .then(res => res.text())
        .then(text => {
            console.log(text);
            if (text == 'logged in') {
                loggedIn();
            }
            else {
                loggedOut();
            }
        });
    }

    function logInOutUser() {
        if ($('LoginLogout').innerHTML == ' Logout ') {
            $('alertPopup').style.display = 'inline-block';
            $('alertContents').innerHTML = miniLoader;

            fetch("logout")
            .then(res => res.text())
            .then(text => {
                $('alertContents').innerHTML = text;
                openMessagePopup(text, false, null);
                loggedOut();
            });
        }
        else {
            openLoginForm(function() { loggedIn(); }, "");
        }
    }

    function loadStatus(glider, dive, setCurr) {
        fetch(`status/${glider}${mission()}`)
        .then(res => res.text())
        .then(text => {
            if (text.includes("not found")) {
                loadControlFile('cmdfile');
                loadControlFile('targets');
                loadControlFile('science');
                return;
            }
            if (text.includes("authorization failed")) {
                openLoginForm(function() { loggedIn(); init(); }, "");
                return;
            }

            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log('loadStatus ' + error);
                console.log(text);
                return;
            }

            if ('error' in data) {
                console.log('loadStatus ' + data['error']);
                return;
            }

            document.title = 'SG' + data['glider'];
            currTitle = 'SG' + data['glider'];
            if (dive == -1 && parseInt(data['dive']) != currDive) {
                currDive = maxDive = parseInt(data['dive']);
                console.log('dive -1 load status maxDive = ' + maxDive);
                
                loadPlots(currDive, setCurr);
                $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;

                // loadLog(currDive);
                updateMaxDive();
            }
            else if (dive > 0 && dive <= parseInt(data['dive'])) {
                maxDive = parseInt(data['dive']);
                currDive = dive;
                console.log('dive 0 load status maxDive = ' + maxDive);

                loadPlots(currDive, setCurr);
                $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;

                // loadLog(currDive);
                updateMaxDive();
            }
            engplotlyplots = data['engplotly'];
            engplots = data['engplots'];
            sgplots = data['sgplots'];
            sgplotlyplots = data['sgplotly'];
            buildTable(glider, -1);
            buildChangelog(3);
            loadAbout(data.mission, data.organization);
            loadRecs();
            loadAnnunciators(glider);
            if (data.mission.status == 'active') {
                setupStream(glider, true, true);
                currStatus = 'active';
            }

            if (currMission == "" && ('mission' in data.mission && data.mission.mission && data.mission.mission != "")) {
                // should we set currMission as well ... will cause all query links to
                // include it which should be fine ??
                $('missionIndex').removeAttribute('hidden');
                $('missionIndexText').innerHTML = data.mission.mission.replaceAll('_', ' ');
            }
            if ('project' in data.mission && data.mission.project && data.mission.project != "") {
                $('projectIndex').removeAttribute('hidden');
                $('projectIndexText').innerHTML = currProject = data.mission.project;
            }

{% if runMode == 'pilot' %}
            targetsChannel = new BroadcastChannel(glider + '-targets');
            targetsChannel.onmessage = (event) => {
                getTargetsFromMap(event.data);
            };
            console.log('loading parms');
            loadParms(glider); // have to wait for maxDive above to be set, also loads, science, targets and cmdfile
{% endif %}
            if ('alert' in data.mission && data.mission.alert && !alertOverride) {
                changeAlertSound(data.mission.alert);
            }
        })
        .catch(error => {
            console.log(error);
        });

	return 0;
    }

    function clearPlots() {
        while($('plotRibbon').firstChild) {
            $('plotRibbon').removeChild($('plotRibbon').firstChild);
        }
        plotList = []
    }

    var prevHighlightID = '';
    var prevHighlightColor = '';  

    function clearTable() {
        while($('mainTable').rows.length > 1) {
            $('mainTable').deleteRow(1);
        }
        prevHighlightID = '';
        prevHighlightColor = '';  
    }

    var plotList = []
    
    function addPlot(which, p, x, plotly) {
        var div = document.createElement('div');
        div.classList.add('thumbDiv');
        img = document.createElement('img');
        img.classList.add('thumbImg');
        img.src = 'plot/webp/' + which + '/' + currGlider + '/' + currDive + '/' + p + mission();
        img.onclick = function() { showPlot(which, p, plotly); };
        img.title = p;
        img.id = 'thumb' + p;
        div.appendChild(img);
        $('plotRibbon').appendChild(div);
        plotList.push( { "name": p, "which": which, "plotly": plotly } );
    }

    function jumpScrollByName(x) {
        i = plotList.map(plotName => plotName.name).indexOf(x);
        if (i > -1) {
            jumpScroll(i);
        }
    }

    function loadLog(dive) {
        fetch(`log/${currGlider}/${dive}${mission()}`)
        .then(res => res.text())
        .then(data => {
            if (data == "none" || data.includes("authorization failed"))
                return;

            // $('logDiv').innerHTML = 'Dive ' + dive + '<br>';
            $('logDiv').innerHTML = '<br>';
            $('logDiv').innerHTML += data;
        })
        .catch(error => {
            console.log(`loadLog - ${error}`);
        });
    }

    function loadEngFile(dive, ext, div) {
        fetch(`file/${ext}/${currGlider}/${dive}${mission()}`)
        .then(res => res.text())
        .then(data => {
            if (data == "none" || data.includes("authorization failed"))
                return;

            const lines = data.split("\n");
            var i, j;
            var columns = null;
            var out = "";
            
            for (i = 0 ; i < lines.length ; i++) {
                if (Array.from(lines[i])[0] == "%") {
                    out = out + lines[i].trim() + "<br>";
                    if (lines[i].includes('columns:')) {
                        columns = lines[i].trim().split(" ")[1].split(",");
                    }
                    if (lines[i].includes('data:')) {
                        out = out + "<table><tr>";
                        for (j = 0 ; j < columns.length ; j++) {
                            out = out + "<th>" + columns[j] + "</th>";
                        }
                        out = out + "</tr>";
                    }
                }
                else {
                    out = out + "<tr>"; 
                    columns = lines[i].trim().split(" ");
                    for (j = 0 ; j < columns.length ; j++) {
                        out = out + '<td>' + columns[j] + '</td>';
                    }
                    out = out + "</tr>"; 
                }
            }
            out = out + '</table>';
            $(div).innerHTML = out;
        })
        .catch(error => {
            console.log(`loadFile - ${ext} ${error}`);
        });
    }
    function loadFile(dive, ext, div) {
        fetch(`file/${ext}/${currGlider}/${dive}${mission()}`)
        .then(res => res.text())
        .then(data => {
            if (data.includes("authorization failed"))
                return;

            if (data == 'none' && ext == 'cap') {
                $('btnCapFile').style.backgroundImage = "url('script/images/cap-none-icon.png')";
                $(div).innerHTML = '<br>no capture file'; 
            }
            else {
                if (ext == 'cap') {
                    const re = new RegExp("[\d]*\.[\d]*,[HS][A-Z]*,C,.*")

                    if (data.search(re) > -1)  {
                        critLine = 'crit0';
                        $('btnCapFile').style.backgroundImage = "url('script/images/cap-crit-icon.png')";
                    }
                    else {
                        critLine = null;
                        $('btnCapFile').style.backgroundImage = "url('script/images/cap-icon.png')";
                    } 

                    
                    setInnerHTML($(div), '<pre>' + data + '</pre>');
                }
                else {
                    $(div).innerHTML = '<pre>' + data + '</pre>';
                }
            }
        })
        .catch(error => {
            console.log(`loadFile - ${ext} ${error}`);
        });
    }
 
    async function loadNotifications(dive) {
        var i;
        var html;
        var pieces;
        var deltas;
        let urls = [`alerts/${currGlider}/${dive}${mission()}`, `deltas/${currGlider}/${dive}${mission()}`];
        let notify = 'none';

        let resp = await Promise.all(urls.map(url => fetch(url).then(res => res.text())));
        let alerts = resp[0];

        if (resp[0].includes("authorization failed") || resp[1].includes("authorization failed"))
            return;

        try {
            deltas = JSON.parse(resp[1]);
        } catch (error) {
            console.log('loadNotifications ' + error);
            console.log(resp[1]);
            deltas = { 'parm': [], 'file': [] };
        }

        if ('error' in deltas) {
            console.log('loadNotifications ' + deltas['error']);
            return;
        }

        // html = `Dive ${dive}<p><h3>alerts</h3><p>`;
        html = '';
        if (alerts != "not found") {
            html += alerts;
            if (alerts.indexOf('CRITICAL:') > -1)
                notify = 'critical';
            else if (alerts.indexOf('ERROR:') > -1)
                notify = 'error';
            else if (alerts.indexOf('WARNING:') > -1)
                notify = 'warning';
            else 
                notify = 'notify';
        }

        html += '<h3 onclick="showPilotWheel(); changeWheelPane(\'History\'); return false;" style="color:blue;">parameter changes</h3><p><table style="margin-left:40px;">';
        for (i = 0 ; i < deltas['parm'].length; i++) {
            pieces = deltas['parm'][i];
            html += `<tr><td><a target="parms" href=\"parms#${pieces['parm'].slice(1)}\">${pieces['parm']}</a>&nbsp;&nbsp;&nbsp;</td><td>${pieces['oldval']}</td><td> <b>&#10230;</b> <td>${pieces['newval']}</td></tr>`;
        } 
        
        html += '</table><p><h3 onclick="showPilotWheel(); changeWheelPane(\'History\'); return false;" style="color:blue;">control files</h3><p>';
        for (i = 0 ; i < deltas['file'].length; i++) {
            html += '<b>' + deltas['file'][i]['file'] + '</b>';
            html += '<div style="margin-left:40px;"><pre>' + deltas['file'][i]['contents'] + '</pre></div>';
        }

        $('notificationsDiv').innerHTML = html;

        if (deltas['file'].length > 0 || deltas['parm'].length > 0) {
            if (notify == 'none')
                notify = 'notify';
        }        

        if (notify == 'critical')  { 
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-icon.png')";
            $('btnNotifications').innerHTML = "<img src='script/images/notification-active-flash-red.png' class='blinkfade'/>";
        }
        else if (notify == 'error')  { 
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-icon.png')";
            $('btnNotifications').innerHTML = "<img src='script/images/notification-active-flash-yellow.png' class='blinkfade'/>";
        }
        else if (notify == 'warning')  { 
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-icon.png')";
            $('btnNotifications').innerHTML = "<img src='script/images/notification-active-flash.png' class='blinkfade'/>";
        }
        else if (notify == 'notify') {
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-active-icon.png')";
            $('btnNotifications').innerHTML = "";
        }
        else {
            $('btnNotifications').style.backgroundImage = "url('script/images/notification-icon.png')";
            $('btnNotifications').innerHTML = "";
        }
    }
 
    function jumpScroll(n) {
        if (n <= plotList.length) {
            $('plotRibbon').scrollTo(200*n, 0, 'smooth');
            $('thumb' + plotList[n].name).click();
        }
        return false;
    }

    function sectionCompare(a, b) {
        
        if (!a.includes('_section_') && !b.includes('_section_'))
            return a.localeCompare(b);
        else if (a.includes('_section_') && !b.includes('_section_'))
            return -1;
        else if (!a.includes('_section_') && b.includes('_section_'))
            return 1;
        else {
            anum = a.split('_').slice(-1)[0];
            bnum = b.split('_').slice(-1)[0];
            aname = a.split('_').slice(0,-2).join('_');
            bname = b.split('_').slice(0,-2).join('_');
            console.log(a, b, anum, bnum, aname, bname);
            if (sectionSortMajor == 'number') {
                if (anum == bnum) {
                    return aname.localeCompare(bname);
                }
                else {
                    if (sectionNumberSort == 'reverse')
                        return bnum.localeCompare(anum);
                    else
                        return anum.localeCompare(bnum);
                }
            }
            else {
                if (aname == bname) {
                    if (sectionNumberSort == 'reverse')
                        return bnum.localeCompare(anum);
                    else
                        return anum.localeCompare(bnum);
                }
                else {
                    return aname.localeCompare(bname);
                }
            }
        } 
    }

    function showRollRecPlot(which) {
        const basis = $('pilotRecsRoll' + which + 'Basis').innerHTML;
        if (basis == 'roll')
            showPlot('dv', 'roll', true);
        else
            showPlot('dv', 'roll_rate', true);
    
        return false;
    }
    function pilotRecsAccept(which) {
        const val = $('pilotRecsModel' + which).innerHTML;
        if ($('paramInput_' + which) && $('paramInput_' + which).value != val) {
            markChanged(which);
            $('paramInput_' + which).value = val;
        }
        updateCmdfileFromParm(which);
        return false; 
    }

    function loadRecs() {
        fetch(`recs/${currGlider}${mission()}`)
        .then(res => res.text())
        .then(data => {
            var r;

            if (data.includes("authorization failed"))
                return;

            try { 
                r = JSON.parse(data);
            } catch(e) {
                console.log('recs ' + e);
                console.log(data);
                return;
            }

            if (r.pitch) {
                $('pilotRecsPitchModelBasis').innerHTML  = r.pitch.rec.model;
                $('pilotRecsFlyingPitchRMSE').innerHTML  = r.pitch.current.rmse.toFixed(2);
                $('pilotRecsModelPitchRMSE').innerHTML   = r.pitch.rec.rmse.toFixed(2);
                $('pilotRecsFlyingC_PITCH').innerHTML    = r.pitch.current.C_PITCH.toFixed(0);
                $('pilotRecsModelC_PITCH').innerHTML     = r.pitch.rec.C_PITCH.toFixed(0);
                $('pilotRecsFlyingPITCH_GAIN').innerHTML = r.pitch.current.PITCH_GAIN.toFixed(1);
                $('pilotRecsModelPITCH_GAIN').innerHTML  = r.pitch.rec.PITCH_GAIN.toFixed(1);
            }
            if (r.vbd) {
                $('pilotRecsFlyingVBDRMSE').innerHTML = r.vbd.current.rmse.toFixed(3);
                $('pilotRecsFlyingC_VBD').innerHTML   = r.vbd.current.C_VBD.toFixed(0);
                $('pilotRecsModelC_VBD').innerHTML    = r.vbd.rec.C_VBD.toFixed(0);
                $('pilotRecsModelVBDRMSE').innerHTML  = r.vbd.rec.rmse.toFixed(3);
                $('pilotRecsVBDModelBasis').innerHTML = r.vbd.rec.model;
            }
            if (r.roll && 'dive' in r.roll && r.roll.dive) {
                $('pilotRecsRollDiveBasis').innerHTML = r.roll.dive.model;
                $('pilotRecsFlyingC_ROLL_DIVE').innerHTML   = r.roll.current.C_ROLL_DIVE.toFixed(0);
                $('pilotRecsModelC_ROLL_DIVE').innerHTML    = r.roll.dive.C_ROLL_DIVE.toFixed(0);
            }
            
            if (r.roll && 'climb' in r.roll && r.roll.climb) {
                $('pilotRecsRollClimbBasis').innerHTML = r.roll.climb.model;
                $('pilotRecsFlyingC_ROLL_CLIMB').innerHTML   = r.roll.current.C_ROLL_CLIMB.toFixed(0);
                $('pilotRecsModelC_ROLL_CLIMB').innerHTML    = r.roll.climb.C_ROLL_CLIMB.toFixed(0);
            }

    
        });
    }
 
    function loadPlots(dive, setCurr) {
        var plots;
        var img;
        var x = 0;
        var idx;
        var cookie;
        var priority;
        var first = false;
        const stockPriority = ["diveplot", "reduced_ctd", "ctd", "ts", "vert_vel_new", "vert_vel_regression", "pitch", "roll", "roll_rate", "magcal", "ctw", "mission_map", "mission_energy", 
                               "wlbb2fl_Chlorophyll_fluorescence", "wlbb2fl_backscatter", "aa4831"];
       
        const subs = { "wlbb2fl_Chlorophyll_fluorescence": "Chlorophyll",
                       "wlbb2fl_backscatter": "backscatter", "ts": "T-S" };

        cookie = readCookie("order");
        if (cookie != null) 
            priority = cookie.split(",");
        else
            priority = stockPriority;

        cookie = readCookie("sectionSort");
        if (cookie != null)
            sectionSortMajor = cookie;

        cookie = readCookie("sectionNumber");
        if (cookie != null)
            sectionNumberSort = cookie;

        currDive = dive; // inside the then or before plots might be actually loaded?

        highlightCurrDive(dive);
        loadLog(dive);
        loadFile(dive, 'log', 'logfileDiv');
        loadEngFile(dive, 'eng', 'engfileDiv');
        loadFile(dive, 'cap', 'capfileDiv');
        loadNotifications(dive);
        $('diveIndicator').innerHTML = 'dive ' + currDive + ': ' + currElt;

        fetch(`plots/${currGlider}/${dive}${mission()}`)
        .then(res => res.text())
        .then(data => {
            if (data.includes("authorization failed"))
                return;

            resp = JSON.parse(data);
            var links = [];
            clearPlots();
            var plots = resp['dvplots'];
            var plotly = resp['plotlyplots'];
            // var engplots = resp['engplots'];
            var eplots = [...engplots];

            var ab = plots.indexOf('ab');
            if (ab > -1 && !priority.includes('ab')) {
                plots.splice(ab, 1);
            }

            for (p of priority) {
                if (plots.includes(p)) {
                    addPlot('dv', p, x, plotly.includes(p));
                    x += 200;
                    idx = plots.indexOf(p);
                    plots.splice(idx, 1); 
                    links.push(p in subs ? subs[p] : p);

                    if (!first && setCurr) {
                        first = true;
                        currElt = p;
                    } 
                }
                else if (eplots.includes(p)) {
                    addPlot('eng', p, x, engplotlyplots.includes(p));
                    x += 200;
                    idx = eplots.indexOf(p);
                    eplots.splice(idx, 1); 
                    links.push(p in subs ? subs[p] : p);

                    if (!first && setCurr) {
                        first = true;
                        currElt = p;
                    } 
                }
            }
            plots.sort();
            for (p of plots) {
                addPlot('dv', p, x, plotly.includes(p));
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }


            if (ab > -1 && !priority.includes('ab')) {
                addPlot('dv', 'ab', x, false);
                links.push('ab' in subs ? subs['ab'] : 'ab');
                x += 200;
            }

            links.push('eng');

            eplots.sort();
            for (p of eplots) {
                addPlot('eng', p, x, engplotlyplots.includes(p));
                links.push(p in subs ? subs[p] : p);
                x += 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                } 
            }

            links.push('sg');
            sgplots.sort(sectionCompare);
            console.log(sgplots);

            for (p of sgplots) {
                addPlot('section', p, x, sgplotlyplots.includes(p));
                links.push(p in subs ? subs[p] : p);
                x+= 200;

                if (!first && setCurr) {
                    first = true;
                    currElt = p;
                }
            }

            if (currElt == 'logfile') 
                showLog(); 
            else if (currElt == 'logfileRaw')
                showLogFile();
            else if (currElt == 'engfile')
                showEng();
            else if (currElt == 'capfile')
                showCap();
            else if (currElt == 'notifications')
                showNotifications();
            else if (currElt == 'pilotWheel') // 'changelog')
                showPilotWheel(); // showChangelog();
            else if (currElt == 'table')
                showTable();
            else if (currElt.includes('plotly')) {
                showPlotly();
/*
                var w = currElt.split('-')[1];
                if (w == 'plot' || w == 'table')
                    doPlotlyPlot(w);
                else if (w == 'profiles' || w == 'contour')
                    doPlotlyProfiles(w);
*/
            }
            else if (engplots.includes(currElt))
                showPlot('eng', currElt, engplotlyplots.includes(currElt));
            else if (sgplots.includes(currElt))
                showPlot('section', currElt, sgplotlyplots.includes(currElt));
            else 
                showPlot('dv', currElt, plotly.includes(currElt));

            // $('mainImage').src = '/plot/png/' + currGlider + '/' + dive + '/diveplot';
            // $('mainImage').removeAttribute('hidden'); 
            // $('mainTable').setAttribute('hidden', ''); 


            var n = links.length - 1;
            var e = links.indexOf('eng');
            var ab = links.indexOf('ab');
            var mn = ab > -1 ? ab - 1 : e - 1;
            var all;

            numPages = parseInt(n / 5) + 1;

            links.splice(e, 1); 

            var sec = links.indexOf('sg');

            var j;
            $('plotRibbonLinks').innerHTML = '<span class="hamburger" onclick="showPlotLinks()">&nbsp;&nbsp;&nbsp;</span>';

            for (var i = 0 ; i < mn ; i += 5) {
                if (i + 4 < mn)
                    j = i+4;
                else
                    j = mn;

                all = links.slice(i,j+1).join(', ');
                $('plotRibbonLinks').innerHTML += '<span class="spanClick jumpLink" onclick="jumpScroll(' + i + ');" title="' + all +'">' + links[i] + '&hellip;' + links[j] + '</span> <b>&#124;</b> '; 
            }
            if (ab > -1) //  && links[j] != 'ab')
                $('plotRibbonLinks').innerHTML += '<span class="spanClick jumpLink" onclick="jumpScroll(' + ab + ');">ab</span> <b>&#124;</b> ';

            mn = sec-1;
            for (var i = e ; i < mn ; i += 5) {
                if (i + 4 < mn)
                    j = i+4;
                else
                    j = mn;

                all = links.slice(i,j+1).join(', ');
                links[i] = links[i].replace('eng_', ''); 
                links[i] = links[i].replace('mission_', ''); 
                links[i] = links[i].replace('SDCARD_', ''); 
                links[i] = links[i].replace('FM_', ''); 
                links[j] = links[j].replace('eng_', ''); 
                links[j] = links[j].replace('mission_', ''); 
                links[j] = links[j].replace('SDCARD_', ''); 
                links[j] = links[j].replace('FM_', ''); 
                $('plotRibbonLinks').innerHTML += '<span class="spanClick jumpLink" onclick="jumpScroll(' + i + ');" title="' + all +'">' + links[i] + '&hellip;' + links[j] + '</span> <b>&#124;</b> '; 
            }

            // all = links.slice(e,sec).join(', ');
            // $('plotRibbonLinks').innerHTML += '<span class="spanClick jumpLink" onclick="jumpScroll(' + e + ');" title="' + all +'">eng</span> * ';

            links.splice(sec, 1); 

            all = links.slice(sec).join(', ');
            $('plotRibbonLinks').innerHTML += '<span class="spanClick jumpLink" onclick="jumpScroll(' + sec + ');" title="' + all +'">sections</span>';
        })
        .catch(error => {
            console.log(`loadPlots - ${error}`);
        });
    }
    
    function highlightCurrDive(dv) {
        if ('row' + dv != prevHighlightID && $('row' + dv) != null) {
            if (prevHighlightID != '') {
                $(prevHighlightID).style.backgroundColor = prevHighlightColor;
            }
            prevHighlightColor = $('row' + currDive).style.backgroundColor;    
            prevHighlightID = 'row' + currDive;
            $('row' + currDive).style.backgroundColor = '#FFCC99';
        }
    }
 
    function changeDive(dir) {
        var c = currDive;

        currDive += dir;
        while (divesInTable.includes(currDive) === false && currDive < maxDive && currDive > 1) {
            currDive += dir;
        }

        if (currDive > maxDive)
            currDive = maxDive;
        else if (currDive < 1)
            currDive = 1;

        if (currDive != c) {
            loadPlots(currDive, false);
            // loadLog(currDive);
        }
    }
     
    function setDive(dive) {
        if (currDive != dive && dive <= maxDive && dive >= 1) {
            currDive = dive;
            loadPlots(currDive, false);
        }
    } 

    function getSelectionText() {
        var text = "";
        var activeEl = document.activeElement;
        var activeElTagName = activeEl ? activeEl.tagName.toLowerCase() : null;
        if (
          (activeElTagName == "textarea") || (activeElTagName == "input" &&
          /^(?:text|search|password|tel|url)$/i.test(activeEl.type)) &&
          (typeof activeEl.selectionStart == "number")
        ) {
            text = activeEl.value.slice(activeEl.selectionStart, activeEl.selectionEnd);
        } else if (window.getSelection) {
            text = window.getSelection().toString();
        }
        return text;
    } 

    function parameterHelp(which) {
        var str = false;

        if (which == 'cmdfile') {
            var s = $(which).selectionStart;
            var e = $(which).selectionEnd;
            var v = $(which).value;

            if (v[s-1] == '$' && v[e] == ',') {
                str = v.substring(s, e);
            }
        }
        else {
            var v = window.getSelection().toString();
            var h = $('logfileDiv').innerHTML; // we look in logfile to see if this is a valid parameter name
            var i = h.indexOf(v);
            if (i > 0 && h[i-1] == '$' && h[i + v.length] == ',') {
                str = v;
            }
        }
            
        if (str) {
            window.open('parms#' + str, 'parms');
        }
    }

    function transpose(matrix) {
        return matrix[0].map((col, i) => matrix.map(row => row[i]));
    }

    function doPlotlyProfiles(which) {
        let x = $('selPlotlyContour').value;
        var binSize = $('selPlotlyZStride').value;
        const whichNames = { 1: "dives", 2: "climbs", 3: "both", 4: "combine" }; 
        let whichProf =  document.querySelector('input[name="plotlyWhichProfiles"]:checked').value; 
        let first = $('txtPlotlyFirstDive').value;
        let last = $('txtPlotlyLastDive').value;
        let step = $('selPlotlyDiveStride').value;
        let top  = $('txtPlotlyTopDepth').value;
        let bot  = $('txtPlotlyBotDepth').value;
 
        $('btnPlotlyContour').disabled = true;
        $('btnPlotlyProfiles').disabled = true;
        var def  = $('btnPlotlyContour').style.backgroundColor;
        $('btnPlotlyContour').style.backgroundColor = 'yellow';
        $('btnPlotlyProfiles').style.backgroundColor = 'yellow';

        permalink = `z=${x}&op=${which}`;
        permalink += `&first=${first}`;
        permalink += `&last=${last}`;
        permalink += `&top=${top}`;
        permalink += `&step=${step}`;
        permalink += `&bottom=${bot}`;
        permalink += `&bin=${binSize}`;
        permalink += `&${whichNames[whichProf]}`;

        fetch(`pro/${currGlider}/${x}/${whichProf}/${first}/${last}/${step}/${top}/${bot}/${binSize}${mission()}`)
        .then(res => res.text())
        .then(data => {
            if (data.includes("authorization failed"))
                return;

            data = data.replaceAll('NaN', 'null');
            data = JSON.parse(data);
            // console.log(data[x]);
            currElt = 'plotly-' + which;
            console.log(currElt);
            $('plotlyPermalink').style.display = 'block';
            if (which == 'contour') {
                var d = [{
                    z: data[x],
                    y: data['depth'],
                    x: data['dive'],
                    type: 'contour',
                    /// xaxis: 'profile',
                    // yaxis: 'depth',
                    connectgaps: $('chkFillGaps').checked,
                    contours: {
                        coloring: 'heatmap',
                        showlabels: true,
                        labelfont: {
                            family: 'Raleway',
                            size: 12,
                            color: 'white',
                        },
                    }, 
                }];
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: 'dive' },
                                yaxis: { title: 'depth', autorange: 'reversed' },
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                
                $('plotlyPlotDiv').removeChild($('plotlyPlotDiv').firstChild);
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
                $('btnPlotlyContour').style.backgroundColor = def;
                $('btnPlotlyContour').disabled = false;
                $('btnPlotlyProfiles').style.backgroundColor = def;
                $('btnPlotlyProfiles').disabled = false;
            }
            else if (which == 'profiles') {
                var d = [];
                let nb = data[x].length;
                let np = data[x][0].length;
                var xd;

                for (var i = 0 ; i < np ; i++) {
                    xd = [];
                    for (var j = 0 ; j < nb ; j++) {
                        xd[j] = data[x][j][i];
                    }
                    d.push({
                            x:xd,
                            y:data['depth'],
                            mode: "lines",
                            type: "scatter",
                            connectgaps: $('chkFillGaps').checked,
                            name: 'dive ' + data['dive'][i]
                           });
                }
                var layout = {
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: x },
                                yaxis: { title: 'depth', autorange: 'reversed' },
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
                $('btnPlotlyContour').style.backgroundColor = def;
                $('btnPlotlyContour').disabled = false;
                $('btnPlotlyProfiles').style.backgroundColor = def;
                $('btnPlotlyProfiles').disabled = false;
            }
        })
        .catch(error => {
            console.log('plotly ' + error);
        })
    }

    function doPlotlyPlot(which) {
        var mode;
        let x = $('selPlotlyX').value;
        let x2 = $('selPlotlyX2').value;
        // let y = $('selPlotlyY').value;
        var y = [...$('selPlotlyY').selectedOptions].map(option => option.value);
        var query;

        //for (var i = 0 ; i < $('selPlotlyY').options.length ; i++) {
        //    if ($('selPlotlyY').options[i].selected)
        //        y.push($('selPlotlyY').options[i].value);
        //}

 
        console.log('do plotly, mode = ' + which);

        permalink = `x=${x}&z=${y.join(',')}&op=${which}`;
        if ($('chkMissionPlots').checked) {
            permalink += '&wholemission';
            if (x2 == '-') {
                query = `query/${currGlider}/${x},${y.join(',')}${mission()}`;
            }
            else {
                query = `query/${currGlider}/${x},${x2},${y.join(',')}${mission()}`;
                permalink += `&y=${x2}`;
            }
            mode = 0;

        }
        else {
            permalink += '&divetimeseries';
            if (x2 == '-') { 
                query = `time/${currGlider}/${currDive}/${x},${y.join(',')}${mission()}`;
            }
            else {
                query = `time/${currGlider}/${currDive}/${x},${x2},${y.join(',')}${mission()}`;
                permalink += `&y=${x2}`;
            }
            mode = 1;
        }

        console.log('mode=' + mode + ' query=' + query);
        fetch(query)
        .then(res => res.text())
        .then(data => {
            if (data.includes("authorization failed"))
                return;

            currElt = 'plotly-' + which;
            console.log(currElt);
            data = data.replaceAll('NaN', 'null');
            data = JSON.parse(data);
            console.log(data);
            $('plotlyPermalink').style.display = 'block';
            if (which == 'plot' && x2 == '-') {
                var d = [];
                var xd = data[x];
                for (var i = 0 ; i < y.length ; i++) {
                    var yd = data[y[i]];
                    d.push({
                            x: xd,
                            y: yd,
                            mode: x == "dive" ? "lines" : "markers",
                            type: "scatter",
                            name: y[i]
                           });
                }
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: x },
                                yaxis: { title: y[0], autorange: y[0].includes('depth') || y[0].includes('pressure') ? 'reversed' : true },
                                title: { text: mode == 1 ? `Dive ${currDive} ${y[0]}` : '', y:0.95, x:0.5},
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                $('plotlyPlotDiv').removeChild($('plotlyPlotDiv').firstChild);
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
            }
            else if (which == 'plot') {
                var d = [];
                var xd = data[x];
                var xd2 = data[x2];
                for (var i = 0 ; i < y.length ; i++) {
                    var yd = data[y[i]];
                    d.push({
                            x: xd,
                            y: xd2,
                            mode: "markers",
                            type: "scatter",
                            name: y[i],
                            marker: {
                                color: yd,
                                colorbar: {
                                    title: y[i],
                                    len: 0.8,
                                },
                                colorscale: "Jet", 
                            }
                           });
                }
                var layout = { 
                                font:       {size: 12},
                                margin: { t:20, l:80, r:80, b:80 },
                                xaxis: { title: x },
                                yaxis: { title: x2, autorange: x2.includes('depth') || x2.includes('pressure') ? 'reversed' : true },
                                plot_bgcolor: "#cccccc",
                                paper_bgcolor: "#bbbbbb",
                             };
                var config = { responsive: true };
                $('plotlyPlotDiv').removeChild($('plotlyPlotDiv').firstChild);
                Plotly.newPlot($('plotlyPlotDiv'), d, layout, config);
            }
            else if (which == 'table') {
                var values = [];
                var headers = [];
                values.push(data[x]);
                headers.push([x]);
                if (x2 != '-') {
                    values.push(data[x2]);
                    headers.push([x2]);
                }
                for (var i = 0 ; i < y.length ; i++) {
                    values.push(data[y[i]]);
                    headers.push([y[i]]);
                }
/*
                var d = [{
                    type: 'table',
                    header: {
                        values: headers,
                        align: 'center',
                        line: { width: 1, color: 'black' },
                        fill: { color: "#aaaaaa" },
                        font: {family: "Arial", size: 12, color: "white"}

                    },
                    cells: {
                        values: values,
                        align: "center",
                        fill: { color: "#eeeeee" } ,
                        line: {color: "#cccccc", width: 1},
                        font: {family: "Arial", size: 11, color: ["black"]}
                    },
                }];
                $('plotlyPlotDiv').removeChild($('plotlyPlotDiv').firstChild);
                Plotly.newPlot($('plotlyPlotDiv'), d);
*/

                t = makeDataTable('plotlyPlotDataTable', headers, values);
                $('plotlyPlotDiv').removeChild($('plotlyPlotDiv').firstChild);
                $('plotlyPlotDiv').append(t);

            }
            else if (which == 'csv') {
                var d = [];
                if (x2 == '-')
                    d.push(([x].concat(y)).join(',')); // headers
                else 
                    d.push(([x,x2].concat(y)).join(',')); // headers

                console.log(d); 
                var o = []; 
                o.push(data[x]);
                if (x2 != '-') 
                    o.push(data[x2]);

                for (var i = 0 ; i < y.length ; i++)
                    o.push(data[y[i]]);

                output = o[0].map((_, colIndex) => o.map(row => row[colIndex]).join(','));
                console.log(output);

                const blob = new Blob([d.concat(output).join('\n')], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('href', url);
                a.setAttribute('download', y[0] + '.csv'); 
                a.click();
            }
            console.log(y);
        })
        .catch(error => {
            console.log('plotly ' + error);
        })
    }

    function emptySelect(s) {
        while(s.options.length > 0)
            s.remove(0);
    }

    function loadPlotlyControlsContour(glider) {
        console.log('loading contour controls');
        fetch(`timevars/${glider}${mission()}`)
        .then(res => res.text())
        .then(text => {
            if (text.includes("not found") || text == 'authorization failed') 
                return;

            try {
                var allnames = JSON.parse(text);  
                var names = [] 
                for (var i = 0 ; i < allnames.length ; i++) {
                    if (!allnames[i].includes('time') && !allnames[i].includes('depth')) {
                        names.push(allnames[i]); 
                    }
                }

                emptySelect($('selPlotlyContour'));
                for (n of names) {
                    let optX = document.createElement('option');
                    optX.value = n;
                    optX.innerHTML = n;
                    let optY = document.createElement('option');
                    $('selPlotlyContour').appendChild(optX);
                }

                if (startZ) {
                    $('selPlotlyContour').value = startZ;
                }     
                if (startOp && (startOp == 'contour' || startOp == 'profiles')) {
                    if (startZ) {
                        startZ = null;
                    }
                    doPlotlyProfiles(startOp); 
                    showPlotly();
                    startOp = null;
                }
            } catch(e) {
                console.log('provars ' + e);
                console.log(text);
            }
        })
        .catch(error => {
            console.log('provars ' + error);
        });

    }

    function loadPlotlyControlsXY(glider) {
        console.log('loading XY controls');
        fetch(`dbvars/${glider}${mission()}`)
        .then(res => res.text())
        .then(text => {
            try {
                data = JSON.parse(text);
            } catch (error) {
                console.log(text);
                return;
            }

	    if (!('names' in data)) {
	    	console.log('no names in data vars');
		return;
	    }
            names = data['names'].sort();
            dv = names.indexOf('dive');
            names.splice(names.indexOf('dive'), 1);
            names = ['dive'].concat(names);

            emptySelect($('selPlotlyX'));
            emptySelect($('selPlotlyX2'));
            emptySelect($('selPlotlyY'));

            let noOpt = document.createElement('option');
            noOpt.value = '-';
            noOpt.innerHTML = '-';
            $('selPlotlyX2').appendChild(noOpt);

            for (n of names) {
                let optX = document.createElement('option');
                optX.value = n;
                optX.innerHTML = n;
                let optX2 = document.createElement('option');
                optX2.value = n;
                optX2.innerHTML = n;
                let optY = document.createElement('option');
                optY.value = n;
                optY.innerHTML = n;
 
                $('selPlotlyX').appendChild(optX);
                $('selPlotlyX2').appendChild(optX2);
                $('selPlotlyY').appendChild(optY);
            }
            if ($('chkMissionPlots').checked) {
                if (startX) {
                    $('selPlotlyX').value = startX;
                    startX = null;
                }
                if (startY) {
                    $('selPlotlyX2').value = startY;
                    startY = null;
                }
                if (startZ) {
                    $('selPlotlyY').value = startZ;
                }
                if (startOp && (startOp == 'plot' || startOp == 'table' || startOp == 'csv')) {
                    if (startZ) {
                        startZ = null;
                    }

                    doPlotlyPlot(startOp);
                    showPlotly();
                    startOp = null;
                }
            }
        })
        .catch(error => {
            console.log('dbvars ' + error);
        });

    }

    function loadPlotlyControlsTS(glider, dive) {
        console.log('loading TS controls');
        fetch(`timevars/${glider}${mission()}`)
        .then(res => res.text())
        .then(text => {
            try {
                 data = JSON.parse(text);
            } catch (error) {
                console.log(text);
                return;
            }

            if ('error' in data) {
                console.log(data['error']);
                return;
            }

            var names = data;
            dv = names.indexOf('time');
            names.splice(names.indexOf('time'), 1);
            names = ['time'].concat(names);

            emptySelect($('selPlotlyX'));
            emptySelect($('selPlotlyX2'));
            emptySelect($('selPlotlyY'));

            let noOpt = document.createElement('option');
            noOpt.value = '-';
            noOpt.innerHTML = '-';
            $('selPlotlyX2').appendChild(noOpt);

            for (n of names) {
                let optX = document.createElement('option');
                optX.value = n;
                optX.innerHTML = n;
                let optX2 = document.createElement('option');
                optX2.value = n;
                optX2.innerHTML = n;
                let optY = document.createElement('option');
                optY.value = n;
                optY.innerHTML = n;
 
                $('selPlotlyX').appendChild(optX);
                $('selPlotlyX2').appendChild(optX2);
                $('selPlotlyY').appendChild(optY);
            }
            if ($('chkTimeseriesPlots').checked) {
                if (startX) {
                    $('selPlotlyX').value = startX;
                    startX = null;
                }
                if (startY) {
                    $('selPlotlyX2').value = startY;
                    startY = null;
                }
                if (startZ) {
                    $('selPlotlyY').value = startZ;
                }
                if (startOp && (startOp == 'plot' || startOp == 'table' || startOp == 'csv')) {
                    if (startZ) {
                        startZ = null;
                    }
                    doPlotlyPlot(startOp);
                    showPlotly();
                    startOp = null;
                }
            }
        })
        .catch(error => {
            console.log('timevars ' + error);
        });

    }

    function switchControls(id) {
        if (id == 'chkTimeseriesPlots' && $(id).checked) {
            $('chkMissionPlots').checked = false;
            console.log('unchecking mission');
            loadPlotlyControlsTS(currGlider, currDive);
            $('labelY').innerHTML = 'Y:';
            $('labelZ').innerHTML = 'Z:';
            // $('selPlotlyX2').disabled = false;
        }
        else if (id == 'chkMissionPlots' && $(id).checked) {
            $('chkTimeseriesPlots').checked = false;
            console.log('unchecking ts');
            loadPlotlyControlsXY(currGlider);
            // $('selPlotlyX2').disabled = true;
            $('labelY').innerHTML = 'Y:';
            $('labelZ').innerHTML = 'Z:';
        }

        if ($('chkMissionPlots').checked == false 
              && $('chkTimeseriesPlots').checked == false) {
            $(id).checked =true;
        } 
    }

    var bodyFudge = 0;

    function init() {
        let path = window.location.pathname.substring(1).split('/');
        let glider = -1;
        let dive = -1;
        let gotCurr = false;

        var scale = 'scale(1.0)';
        document.body.style.webkitTransform =  scale;    // Chrome, Opera, Safari
        document.body.style.msTransform =   scale;       // IE 9
        document.body.style.transform = scale;     // General

        if (path.length >= 1) {
            glider = path[path.length - 1]
            console.log(glider);
        }

        let params = new URLSearchParams(window.location.search);
        if (params.has('dive')) {
            dive = parseInt(params.get('dive'));
        }
        if (params.has('mission')) {
            currMission = params.get('mission');
        }
        if (params.has('plot')) {
            currElt = params.get('plot');
            gotCurr = true;
        }
        if (params.has('order')) {
            createCookie("order", params.get('order'), 180);
        }
        if (params.has('sectionSort')) {
            createCookie("sectionSort", params.get('sectionSort'), 180);
        }
        if (params.has('sectionNumber')) {
            createCookie("sectionNumber", params.get('sectionNumber'), 180);
        }
 
        // set mobile based on media query
        if (window.matchMedia("(pointer: coarse)").matches) {
            mobile = true;
        }

        // check if user has spec'd an override to mobile,
        // if so set (or reset) the local storage for
        // the subsequent query
        if (params.has('mobile')) 
            localStorage.setItem('visMode', 'mobile');
        else if (params.has('desktop'))
            localStorage.setItem('visMode', 'desktop');

        var alertSound = localStorage.getItem('alert');
        if (alertSound === null)
            alertSound = '{{ alert }}';

        if (params.has('alert')) {
            alertSound = params.get('alert');
            localStorage.setItem('alert', alertSound);
            alertOverride = true;
        }

        changeAlertSound(alertSound);
    
        // check local storage to see if user has a 
        // preferred override mode - if so, set it
        let mode = localStorage.getItem('visMode');
        if (mode && mode == 'mobile') {
            mobile = true; 
        }
        else if (mode && mode == 'desktop') {
            mobile = false;
        }

        if (mobile) 
            visClass = 'mobile';
        else
            visClass = 'desktop';

        if (glider == -1) {
            alert('invalid request - specify glider');
            console.log('invalid request - specify glider');
            return;
        }
/*
        if (path.length > 1) {
            window.history.replaceState('object or string', 'Title', `/${glider}`);
        }
*/

        if (currMission != '') {
            $('missionIndex').removeAttribute('hidden');
            $('missionIndexText').innerHTML = currMission.replaceAll('_', ' ');
        }

        checkUser();

        $('gliderIndexText').innerHTML = 'SG' + glider;

        currGlider = glider;
        console.log(glider);
        window.name = 'SG' + glider;

        loadStatus(glider, dive, !gotCurr);
        // setupStream(glider, true, true);
{% if runMode == 'pilot' %}
	    // called by loadStatus or loadParms now
        // loadControlFile('cmdfile'); // still do this? vs loadParms?
        // loadControlFile('science'); call these from fetch of loadStatus
        // loadControlFile('targets');
        loadControlFile('scicon.sch');
        loadControlFile('tcm2mat.cal');
        loadControlFile('pdoscmds.bat');
        loadControlFile('sg_calib_constants.m');
        loadEditlog('cmdedit');
        loadEditlog('targedit');
        loadEditlog('sciedit');
        $('selectFile').value = 'cmdfile';
        changeFile();
        initTargetsEntryTable();
{% endif %}
        loadPlotlyControlsXY(glider);
        loadPlotlyControlsContour(glider);
        $('chkMissionPlots').checked = true;
        $('chkTimeseriesPlots').checked = false;

{% if runMode == 'pilot' %}
{% if noChat == false %}
        dragElement($('chatDiv'));
        $('attachImage').addEventListener('change', attachImageChange);
        $('modalImgClose').onclick = function() {
            $('modalImgDiv').style.display = "none";
        }
{% endif %}
{% endif %}

        if (params.has('bin')) {
            $('selPlotlyZStride').value = params.get('bin');
        }
        if (params.has('top')) {
            $('txtPlotlyTopDepth').value = params.get('top');
        }
        if (params.has('bottom')) {
            $('txtPlotlyBotDepth').value = params.get('bottom');
        }
        if (params.has('first')) {
            $('txtPlotlyFirstDive').value = params.get('first');
        }
        if (params.has('last')) {
            $('txtPlotlyLastDive').value = params.get('last');
            lastDive = params.get('last');
        }
        if (params.has('step')) {
            $('selPlotlyDiveStride').value = params.get('step');
        }
        if (params.has('op')) {
             startOp = params.get('op');
             currElt = 'plotly-' + startOp;
        }

        if (params.has('wholemission')) { 
            $('chkMissionPlots').checked = true;
            switchControls('chkMissionPlots');
        }
        else if (params.has('divetimeseries')) {
            $('chkTimeseriesPlots').checked = true;
            switchControls('chkTimeseriesPlots');
        }

        if (params.has('dives'))
            $('radPlotlyDives').checked = true;
        else if (params.has('climbs'))
            $('radPlotlyClimbs').checked = true;
        else if (params.has('both'))
            $('radPlotlyBoth').checked = true;
        else if (params.has('combine'))
            $('radPlotlyCombine').checked = true;

        if (params.has('x')) {
            startX = params.get('x');
        }
        if (params.has('y')) {
            startY = params.get('y');
        }
        if (params.has('z')) {
            startZ = params.get('z');
        }

        document.onkeydown = function (event) {
            const excl = ['input', 'textarea'];
            if (excl.includes(event.target.tagName.toLowerCase()))
                return;

            var idx;
            const key = event.key;
            if (key == 'a' || key == 'h') {
                idx = plotList.map(p => p.name).indexOf(currElt);
                if (idx > 0) {
                    idx --;
                    $('thumb' + plotList[idx].name).click();
                }
            }
            else if (key == 'd' || key == 'l') {
                idx = plotList.map(p => p.name).indexOf(currElt);
                if (idx < (plotList.length - 1)) {
                    idx ++;
                    $('thumb' + plotList[idx].name).click();
                }
            }
            else if (key == 'w' || key == 'k')
                changeDive(1);
            else if (key == 's' || key == 'j')
                changeDive(-1);
            else if ("123456789".includes(key) && parseInt(key) <= numPages) {
                jumpScroll((parseInt(key) - 1)*5);
            }

        };

        $('plotRibbon').addEventListener("wheel", (evt) => {
            evt.preventDefault();
            $('plotRibbon').scrollLeft += evt.deltaY;
        });

        if (mobile) {
            document.body.addEventListener("focus", event => {
                const target = event.target;
                switch (target.id) {
                    case "cmdfile":
                    case "targets":
                    case "science":
                    case "scicon.sch":
                    case "sg_calib_constants.m":
                    case "pdoscmds.bat":
                    case "tcm2mat.cal":
                        $('divCmdfile').classList.add("editing");   
                        document.body.scrollTo( { top: 0, left: 0 } );
                        window.scrollTo( { top: 0, left: 0 });
                        $('divCmdfile').scrollIntoView();
                        $('navLinks').scrollIntoView();
                        $('cmdfileEditClose').style.display = "block";
                        
                }
            }, true); 
            document.body.addEventListener("blur", () => {
                defocusEditWindow();
            }, true); 
        }

        setupProcessBar();

        const elements = document.querySelectorAll('body *');

        elements.forEach((element) => {
            element.classList.add(visClass);
        });
    }

    function defocusEditWindow() {
        $('divCmdfile').classList.remove("editing");
        $('cmdfileEditClose').style.display = "none";
    }

    function showRibbon() {
        if ($('plotRibbonBox').style.display == 'none')
            $('plotRibbonBox').style.display = 'block';
        else
            $('plotRibbonBox').style.display = 'none';
    }

{% if runMode == 'pilot' %}
    var rightMode = 'grid';
    function toggleRight() {
        const collection = document.getElementsByClassName("plotly-graph-div"); 
        if ($('right').style.display == 'none') {
            $('right').style.display = rightMode;
            $('toggleRight').innerHTML = 'Hide pilot';
            Plotly.Plots.resize(collection[0]);
        }
        else {
            rightMode = $('right').style.display;
            $('right').style.display = 'none';
            $('toggleRight').innerHTML = 'Show pilot';
            Plotly.Plots.resize(collection[0]);
        }
    }
{% endif %}
        
</script>

<html>
<body onload="init();" style="font-family: verdana, arial, tahoma, 'sans serif';">

<div id="bodyView">

<div id="navLinks">
    <a href="./" target="index">Index</a> <b>&#124;</b> 
    <a href="dash" target="dash"> Dashboard </a> <b>&#124;</b> 
{% if runMode == 'pilot' %}
{% if noChat == false %}
    <span class="spanClick" onclick="chatShow(); return false;">Chat</span> <b>&#124;</b>
{% endif %}
{% endif %}
    <span class="spanClick" onclick="openAboutForm(); return false;">About</span> <b>&#124;</b>
    <div class="dropdown">
        <span class="spanClick droplink">Tools </span><b>&#124;</b>
        <div class="dropdown-content">
            <span class="spanClick" onclick="popupPosition(); return false;">Position</span>
            <span class="spanClick" onclick="openRegressionForm(); return false;">VBD regression</span>
            <span class="spanClick" onclick="openBallastSheet(); return false;">Ballast worksheet</span>
            <span class="spanClick" onclick="openMagcalForm(); return false;">Compass calibration</span>
        </div>
    </div>
    <span id="projectIndex" hidden="hidden"> <span id="projectIndexText" class="spanClick" onclick="projectIndex(); return false;">Project</span> <b>&#124;</b> </span>
    <span id="missionIndex" hidden="hidden"> <span id="missionIndexText" class="spanClick" onclick="missionIndex(); return false;">Mission</span> <b>&#124;</b> </span>
    <span id="gliderIndex"><span id="gliderIndexText" class="spanClick" onclick="gliderIndex(); return false;">Glider</span> <b>&#124;</b> </span>
    <a href="help" target="help"> Help </a> 

    
{% if runMode == 'pilot' %}

    <span style="float:right; padding-right: 10px;">
    <span class="spanClick" id="LoginLogout" onclick="logInOutUser();"> Login </span>  
    <b>&#124;</b><span class="spanClick" id="toggleRight" onclick="toggleRight(); return false;"> Hide pilot</span></span>
{% endif %}
</div>



<div id="toolbar">
    <div class="toolTop">
        <button class="tool" id="btnDiveUp"        onclick="changeDive(1);" title="next dive [w,k] "></button>
        <button class="tool" id="btnDiveTable"     onclick="showTable();" title="dives table"></button>
        <button class="tool" id="btnDiveDown"      onclick="changeDive(-1);" title="prev dive [s,j]"></button>
        <button class="tool" id="btnNotifications" onclick="showNotifications();" title="notifications"></button>
        <button class="tool" id="btnCapFile"       onclick="showCap();" title="capture file"></button>
        <button class="tool" id="btnLogTable"      onclick="showLog();" title="log summary"></button>
        <button class="tool" id="btnPlotTool"      onclick="showPlotly();" title="plot and table tool"></button>
        <button class="tool" id="btnLogFile"       onclick="showLogFile();" title="log file"></button>
        <button class="tool" id="btnEngFile"       onclick="showEng();" title="engineering file"></button>
{% if runMode == 'pilot' %}
        <button class="tool" id="btnPilotWheel"    onclick="showPilotWheel();" title="pilot controls"></button>
{% endif %}
        <button class="tool" id="btnSearchTool"    onclick="showSearchTool();" title="search tool"></button>
    </div>

    <div class="toolBottom">
        <button class="tool" id="btnMap"      onclick="popupMap();" title="map"></button>
        <button class="tool" id="btnSelftest" onclick="popupSelftest();" title="selftest"></button>
    </div>
</div>

<div id="main">
    <div id="ribbonExpander" onclick="showRibbon(); return false;">&#10063;&#10063&#10063;</div>
    <div id="plotlyPopperOuter">&#x2922;</div>
    <span id="diveIndicator"></span>
<!--
    <div id="alertPopup" style="display: none;" class="alert-popup">
        <div id="alertContents">
        </div>
        <button id="alertOk" type="submit" class="btn">ok</button>
        <button id="alertCancel" type="submit" class="btn cancel" style="display: none"; onclick="$('alertPopup').style.display = 'none';">cancel</button>
    </div>
-->
    <div id="waitIndicator" style="display: none;">
        <div class="loader-container">
            <div class="bouncing-dots">
                <div class="dot"></div>
                <div class="dot dot1"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>
    <div id="plotlyPermalink" onclick="showPermalink();">&#x1F517;</div>
    <img id="mainImage" style="mix-blend-mode:multiply;" class="hide">
    <div id="mainDiv" class="mainViewport" style="mix-blend-mode:multiply;" class="hide">
    </div>
    <table rules="groups" id="mainTable" class="hide">

        <colgroup span=4><col><col><col><col></colgroup>
        <colgroup span=6><col><col><col><col><col><col><col></colgroup>
        <colgroup span=2><col><col></colgroup>
        <colgroup span=2><col><col></colgroup>
        <colgroup span=2 id="volt10_group"><col class="volt10"><col class="volt10"></colgroup>
        <colgroup span=2 id="volt24_group"><col class="volt24"><col class="volt24"></colgroup>
        <colgroup span=1><col></colgroup>
        <tbody>
            <tr bgcolor="#aaaaaa" align="center">
                <th>dive</th>
                <th>end</th>
                <th>length</th>
                <th>depth</th>
                <th>dog</th>
                <th>cog</th>
                <th>dtw</th>
                <th>ctw</th>
                <th>dtg</th>
                <th>ctg</th>
                <th>OG eff.</th>
                <th>Umag</th>
                <th>Udir</th>
                <th>RH</th>
                <th>int P</th>
                <th id="volt10_header" class="volt10">volts10</th>
                <th id="cap10_header" class="volt10">% cap</th>
                <th id="volt24_header" class="volt24">volts24</th>
                <th id="cap24_header" class="volt24">% cap</th>
                <th>errors</th>
            </tr>
        </tbody>
    </table>
    <div id="searchToolDiv" class="hide" style="text-align: left; margin-left: 10px;">
        <div id="searchToolControls">
            <input type="radio" id="searchToolWhichCommLog" name="searchToolWhichFiles" value="comm" checked>
            <label for="searchToolWhichCommLog">comm.log</label>
            <input type="radio" id="searchToolWhichLogFiles" name="searchToolWhichFiles" value="log">
            <label for="searchToolWhichLogFiles">log files</label>
            <input type="radio" id="searchToolWhichEngFiles" name="searchToolWhichFiles" value="eng">
            <label for="searchToolWhichLogFiles">eng files</label>
            <input type="radio" id="searchToolWhichCapFiles" name="searchToolWhichFiles" value="cap">
            <label for="searchToolWhichLogFiles">cap files</label>
            <br>
            <input type="radio" id="searchToolWhichCmdfiles" name="searchToolWhichFiles" value="cmdfile">
            <label for="searchToolWhichCommLog">cmdfile(s)</label>
            <input type="radio" id="searchToolWhichPdosBat" name="searchToolWhichFiles" value="pdosbat">
            <label for="searchToolWhichPdosBat">pdoscmd.bat(s)</label>
            <input type="radio" id="searchToolWhichPdosLog" name="searchToolWhichFiles" value="pdoslog">
            <label for="searchToolWhichPdosLog">pdos logs</label>
            <input type="radio" id="searchToolWhichBaselog" name="searchToolWhichFiles" value="baselog">
            <label for="searchToolWhichBaselog">baselog.log</label>
            <p>
            <input type="radio" id="searchToolSelftest" name="searchToolWhichDives" value="selftest">
            <label for="searchToolSelftest">selftest(s)</label>
            <input type="radio" id="searchToolAllDives" name="searchToolWhichDives" value="all" checked>
            <label for="searchToolAllDives">all dives</label>
            <input type="radio" id="searchToolDiveRange" name="searchToolWhichDives" value="range">
            <label for="searchToolDiveRange">dive range:</label>
            <label for="searchToolFirstDive">first</label> 
            <input id="searchToolFirstDive" size="5">
            <label for="searchToolLastDive">last</label> 
            <input id="searchToolLastDive" size="5">
            <p>
            <input id="searchToolIncludeFilename" type="checkbox">
            <label for="searchToolIncludeFilename">include filename</label>
            <input id="searchToolIncludeDiveNumber" type="checkbox" checked>
            <label for="searchToolIncludeDiveNumber">include dive number</label>
            <p>
            <label for="searchToolTerm">search term</label>
            <input id="searchToolTerm">
            <p>
            <input type="button" value="search" onclick="searchTool(); return false;">
            <span id="searchStatus"></span>
            <p>
            <input type="button" value="filter" onclick="searchToolFilter(); return false;">
            <label for="searchToolFilterFields">fields</label> 
            <input id="searchToolFilterFields" size="5">
            <input type="button" value="plot x,y..." onclick="searchToolPlot(1); return false;">
            <input type="button" value="plot y,y..." onclick="searchToolPlot(0); return false;">
           <hr>
        </div>
        <div id="searchToolResults" class="pre">

        </div>
        <div id="searchToolPlot">
        </div>
    </div>

{% if runMode == 'pilot' %}
    <div id="pilotWheelDiv" class="hide" style="text-align: left; height: 100vh; overflow-y: none;">
        <div id="pilotWheelNavBar" style="padding: 5px; top: 0px; position: sticky; background: rgba(170,170,170,1);">
            <span id="tabTrim" class="spanClick" onclick="changeWheelPane('Trim'); return false;">trim</span> <b>&#124;</b>
            <span id="tabCmdfile" class="spanClick" onclick="changeWheelPane('Cmdfile'); return false;">cmdfile</span> <b>&#124;</b>
            <span id="tabScience" class="spanClick" onclick="changeWheelPane('Science'); return false;">science</span> <b>&#124;</b>
            <span id="tabTargets" class="spanClick" onclick="changeWheelPane('Targets'); return false;">targets</span> <b>&#124;</b>
            <span id="tabHistory" class="spanClick" onclick="changeWheelPane('History'); return false;">history</span> <b>&#124;</b>
            <span id="tabLogs" class="spanClick" onclick="changeWheelPane('Logs'); return false;">logs</span> 
        </div>
       
        <div id="pilotWheelTrim" class="hide" style="padding: 4px;">
            <div id="pilotRecsList">
                <table>
                    <tr><td colspan="4"><span class="spanClick" onclick="showPlot('dv', 'pitch', true); return false;"><b>Pitch</b></span> (based on <span id="pilotRecsPitchModelBasis"></span> model)</td></tr>
                    <tr><th></th><th>current</th><th>model suggests</th><th></th></tr>
                    <tr><td>RMSE</td><td id="pilotRecsFlyingPitchRMSE"></td>
                                     <td id="pilotRecsModelPitchRMSE"></td><td></td>
                    <tr><td><b><a href="parms#C_PITCH" target="parms">C_PITCH</a></b></td>
                        <td id="pilotRecsFlyingC_PITCH"></td>
                        <td id="pilotRecsModelC_PITCH"></td>
                        <td><input type="button" value="accept" onclick="pilotRecsAccept('C_PITCH');"</td></tr>
                    <tr><td><b><a href="parms#PITCH_GAIN" target="parms">PITCH_GAIN</a></b></td>
                        <td id="pilotRecsFlyingPITCH_GAIN"></td>
                        <td id="pilotRecsModelPITCH_GAIN"></td>
                        <td><input type="button" value="accept" onclick="pilotRecsAccept('PITCH_GAIN');"</td></tr>

                    <tr><td colspan="4">&nbsp;</td></tr>
                    <tr><td colspan="4"><span class="spanClick" onclick="showPlot('dv', 'vert_vel_new', true); return false;"><b>VBD</b></span> (based on <span id="pilotRecsVBDModelBasis"></span> model)</td></tr>
                    <tr><th></th><th>current</th><th>model suggests</th><th></th></tr>
                    <tr><td>RMSE</td><td id="pilotRecsFlyingVBDRMSE"></td>
                                     <td id="pilotRecsModelVBDRMSE"></td><td></td>
                    <tr><td><b><a href="parms#C_VBD" target="parms">C_VBD</a></b></td>
                        <td id="pilotRecsFlyingC_VBD"></td>
                        <td id="pilotRecsModelC_VBD"></td>
                        <td><input type="button" value="accept" onclick="pilotRecsAccept('C_VBD');"</td></tr>

                    <tr><td colspan="4">&nbsp;</td></tr>
                    <tr><td colspan="4"><span class="spanClick" onclick="showRollRecPlot('Dive');"><b>Roll: dive</b></span> (based on <span id="pilotRecsRollDiveBasis"></span> model)</td></tr>
                    <tr><th></th><th>current</th><th>model suggests</th><th></th></tr>
                    <tr><td><b><a href="parms#C_ROLL_DIVE" target="parms">C_ROLL_DIVE</a></b></td>
                        <td id="pilotRecsFlyingC_ROLL_DIVE"></td>
                        <td id="pilotRecsModelC_ROLL_DIVE"></td>
                        <td><input type="button" value="accept" onclick="pilotRecsAccept('C_ROLL_DIVE');"</td></tr>
                    <tr><td colspan="4"><span class="spanClick" onclick="showRollRecPlot('Climb');"><b>Roll: climb</b></span> (based on <span id="pilotRecsRollClimbBasis"></span> model)</td></tr>
                    <tr><td><b><a href="parms#C_ROLL_CLIMB" target="parms">C_ROLL_CLIMB</a></b></td>
                        <td id="pilotRecsFlyingC_ROLL_CLIMB"></td>
                        <td id="pilotRecsModelC_ROLL_CLIMB"></td>
                        <td><input type="button" value="accept" onclick="pilotRecsAccept('C_ROLL_CLIMB');"</td></tr>

                </table>
            </div>
        </div>
 
        <div id="pilotWheelCmdfile" style="height: 100vh;">
            <div id="pilotCmdfileNavBar" style="padding: 5px; top: 0px; position: sticky; background: rgba(170,170,170,1);">
                <span id="tabBASIC" class="spanClick" onclick="changeParmGroup('BASIC'); return false;">Basic</span> <b>&#124;</b>
                <span id="tabNAV" class="spanClick" onclick="changeParmGroup('NAV'); return false;">Navigation</span> <b>&#124;</b>
                <span id="tabDIVE" class="spanClick bold" onclick="changeParmGroup('DIVE'); return false;">Dive</span> <b>&#124;</b>
                <span id="tabSURFACE" class="spanClick" onclick="changeParmGroup('SURFACE'); return false;">Surface</span> <b>&#124;</b>
                <span id="tabFLIGHT" class="spanClick" onclick="changeParmGroup('FLIGHT'); return false;">Flight</span> <b>&#124;</b>
                <span id="tabPITCH" class="spanClick" onclick="changeParmGroup('PITCH'); return false;">Pitch</span> <b>&#124;</b>
                <span id="tabROLL" class="spanClick" onclick="changeParmGroup('ROLL'); return false;">Roll</span> <b>&#124;</b>
                <span id="tabVBD" class="spanClick" onclick="changeParmGroup('VBD'); return false;">VBD</span> <b>&#124;</b>
                <span id="tabALTIMETER" class="spanClick" onclick="changeParmGroup('ALTIMETER'); return false;">Altimeter</span> <b>&#124;</b>
                <span id="tabPOWER" class="spanClick" onclick="changeParmGroup('POWER'); return false;">Power</span> <b>&#124;</b>
                <span id="tabHARDWARE" class="spanClick" onclick="changeParmGroup('HARDWARE'); return false;">Hardware</span> 
            </div>
            <div id="pilotWheelCmdfileControls">
                <div id="pilotParmsList">
                    
                    <div id="pilotBASIC" class="hide" oncontextmenu="parameterHelp('pilotBASIC');"></div>
                    <div id="pilotNAV" class="hide" oncontextmenu="parameterHelp('pilotNAV');"></div>
                    <div id="pilotDIVE" oncontextmenu="parameterHelp('pilotDIVE');"> 
                        &nbsp; <span id="pilotVertVelResult" style="display: inline-block; width: 11ch; min-width: 11ch; max-width: 11ch;">w= cm/s</span>
                        Quick w:
                        <span class="spanClick" onclick="pilotVertVel(8);">8</span>&nbsp;
                        <span class="spanClick" onclick="pilotVertVel(9);">9</span>&nbsp;
                        <span class="spanClick" onclick="pilotVertVel(10);">10</span>&nbsp;
                        <span class="spanClick" onclick="pilotVertVel(11);">11</span>&nbsp;
                        <span class="spanClick" onclick="pilotVertVel(12);">12</span>&nbsp;
                        <span class="spanClick" onclick="pilotVertVel(13);">13</span>&nbsp;
                        <span class="spanClick" onclick="pilotVertVel(14);">14</span>&nbsp;
                        <span class="spanClick" onclick="pilotVertVel(15);">15</span>&nbsp;
                        <span class="spanClick" onclick="pilotVertVel(16);">16</span>&nbsp;
                        <span class="spanClick" onclick="pilotVertVel(18);">18</span>&nbsp;
                        <span class="spanClick" onclick="pilotVertVel(20);">20</span>
                    </div>
                    <div id="pilotSURFACE" class="hide" oncontextmenu="parameterHelp('piotSURFACE');"></div>
                    <div id="pilotFLIGHT" class="hide" oncontextmenu="parameterHelp('pilotFLIGHT');"></div>
                    <div id="pilotPITCH" class="hide" oncontextmenu="parameterHelp('pilotPITCH');"></div>
                    <div id="pilotROLL" class="hide" oncontextmenu="parameterHelp('pilotROLL');"></div>
                    <div id="pilotVBD" class="hide" oncontextmenu="parameterHelp('pilotVBD');"></div>
                    <div id="pilotALTIMETER" class="hide" oncontextmenu="parameterHelp('pilotALTIMETER');"></div>
                    <div id="pilotPOWER" class="hide" oncontextmenu="parameterHelp('pilotPOWER');"></div>
                    <div id="pilotHARDWARE" class="hide" oncontextmenu="parameterHelp('pilotHARDWARE');"></div>
                </div>
                
                <div id="pilotDirectiveList">
                    <input type="radio" id="radPilotDirectiveGO" name="radPilotDirective" value="GO" checked onclick="changeDirective('GO');">
                    <label for="radPilotDirectiveGO">GO</label>
                    <input type="radio" id="radPilotDirectiveQUIT" name="radPilotDirective" value="QUIT" onclick="changeDirective('QUIT');">
                    <label for="radPilotDirectiveQUIT">QUIT</label>
                    <input type="radio" id="radPilotDirectiveRESUME" name="radPilotDirective" onclick="changeDirective('RESUME');" value="RESUME">
                    <label for="radPilotDirectiveRESUME">RESUME</label>
                    <hr>
                    <input type="button" id="btnParamSearch" onclick="doParamSearch();" value="search parameters">
                    <input id="txtParamSearch" class="parmInputInput">
                    <span onclick="clearParamSearch();" class="spanClick">&otimes;</span>
                    <p>
                    <div id="divParamSearchResults">
                    </div>
                    <hr>
                </div>
            </div>
        </div>
        <div id="pilotWheelScience" class="hide">
            <span id="spnScienceEditorInfo">Sensor configuration from dive x, initial table from science.x</span><br>
            <input type="button" value="Make science file" onclick="writeScienceFileToEditor(); return false;">
            <input type="button" value="Add row" onclick="addNewScienceFileRow();">
            <table>
                <thead>
                    <tr><th colspan="13"/><th colspan="13" align="center" style="background: #aaaaaa;">options</th>
                    <tr><th/><th/><th/><th/><th id="scienceSampleIntervals" colspan="8" align="center" style="background: #aaaaaa;">sample intervals (s)</th><th/><th/><th colspan="6" align="center" style="background: #aaaaaa;"><u>D</u>ive and/or <u>C</u>limb</th><th colspan="6" align="center" style="background: #aaaaaa;">which dives</th>
                    <tr class="vertRow">
                        <th></th>
                        <th id="thDepthLims" colspan=2 style="background: #cccccc;" align="center" style="writing-mode: horizontal-tb !important;">depths</th>
                        <th>wake (s)</th>
                        <th id="scienceSensor1">sensor 1</th>
                        <th id="scienceSensor2">sensor 2</th>
                        <th id="scienceSensor3">sensor 3</th>
                        <th id="scienceSensor4">sensor 4</th>
                        <th id="scienceSensor5">sensor 5</th>
                        <th id="scienceSensor6">sensor 6</th>
                        <th id="scienceCompass">compass</th>
                        <th id="sciencePressure">pressure</th>

                        <th>GC (s)</th>
                        
                        <th id="scienceTimeout">timeout</th>
                        <th id="scienceProfiles1">sensor 1</th>
                        <th id="scienceProfiles2">sensor 2</th>
                        <th id="scienceProfiles3">sensor 3</th>
                        <th id="scienceProfiles4">sensor 4</th>
                        <th id="scienceProfiles5">sensor 5</th>
                        <th id="scienceProfiles6">sensor 6</th>
                        <th id="scienceDives1">sensor 1</th>
                        <th id="scienceDives2">sensor 2</th>
                        <th id="scienceDives3">sensor 3</th>
                        <th id="scienceDives4">sensor 4</th>
                        <th id="scienceDives5">sensor 5</th>
                        <th id="scienceDives6">sensor 6</th>

                    </tr>
                </thead>
                <tbody id="scienceTable">
                </tbody>
            </table>
        </div>
        <div id="pilotWheelTargets" class="hide">
            <div id="pilotWheelTargetsEntry">
                <table>
                    <tbody id="targetsEntryTable">
                        <tr><td>name</td><td><input id="targetsname"></td></tr>
                    </tbody>
                </table>
                <input type="button" id="btnTargetSubmit" value="update" onclick="addUpdateTarget();">
            </div>
            <div id="pilotWheelTargetsList">
                <table>
                    <tbody id="targetsList" style="font-family:monospace;"></tbody>
                </table>
                <input type="button" value="Copy selected" onclick="copySelectedTarget();">
                <input type="button" value="Make targets file" onclick="writeTargetsFile();">
                <input type="button" value="Send to map" onclick="sendTargetsToMap();">
                <p> 
                <b>intermediate target generation</b> 
                <br>(inserts from target above selected target to selected target): 
                <br>
                number <input value="3" id="intermediateCount" size="4">
                radius <input value="1000" id="intermediateRadius" size="5">
                <input type="button" value="insert" onclick="insertTargets();">
            </div>
        </div>
        <div id="pilotWheelLogs" class="hide">
            <div id="pilotLogsNavBar" style="padding: 5px; top: 0px; position: sticky; background: rgba(170,170,170,1);">
                <span id="tabCmdedit" class="spanClick" onclick="changeEditlog('Cmdedit'); return false;">Cmdfile</span> <b>&#124;</b>
                <span id="tabTargedit" class="spanClick" onclick="changeEditlog('Targedit'); return false;">Targets</span> <b>&#124;</b>
                <span id="tabSciedit" class="spanClick" onclick="changeEditlog('Sciedit'); return false;">Science</span> 
            </div>
            <div id="pilotCmdedit">
                <div id="cmdedit" class="pre">
                </div>
            </div>
            <div id="pilotTargedit" class="hide">
                <div id="targedit" class="pre">
                </div>
            </div>
            <div id="pilotSciedit" class="hide">
                <div id="sciedit" class="pre">
                </div>
            </div>
        </div>
        <div id="pilotWheelHistory" style="margin-left:20px; text-align:left;" oncontextmenu="parameterHelp('pilotWheelHistory');" class="hide">
            <div id="changelogParms">
                Sort by
                <input type="radio" id="radSortDives" name="changelogSortParm" value="dive" checked onchange="buildChangelog(1);">
                <label for="radSortDives">dive</label>
                <input type="radio" id="radSortParms" name="changelogSortParm" value="parm" onchange="buildChangelog(1);"> 
                <label for="radSortParms">parameter</label>
                <p>
                <div id="changelogTable">
                </div>
            </div>
            <div id="changelogFiles">
                Sort by
                <input type="radio" id="radFileDives" name="changelogSortFile" value="dive" checked onchange="buildChangelog(2);">
                <label for="radFileDives">dive</label>
                <input type="radio" id="radFileParms" name="changelogSortFile" value="file" onchange="buildChangelog(2);"> 
                <label for="radFileParms">file</label>
                <p>
                <div id="changelogFilesContent">
                </div>
            </div>
        </div>
    </div>
{% endif %}
    <div id="logDiv" class="hide"></div>
    <div id="notificationsDiv" style="margin-left:20px; text-align:left;" oncontextmenu="parameterHelp('notificationsDiv');" class="hide"></div>
    
    
    <div id="plotlyDiv" class="hide">
        <div id="plotyConfigXYDiv">
            <span id="labelX">X:</span><select id="selPlotlyX"></select><br>
            <span id="labelY">Y:</span><select id="selPlotlyX2"></select> <br>
            <input type="checkbox" checked id="chkMissionPlots" onclick="switchControls(this.id);"><label for="chkMissionPlots">whole mission</label>
            <input type="checkbox" id="chkTimeseriesPlots" onclick="switchControls(this.id);"><label for="chkTimeseriesPlots">dive time series</label><br>
        </div>
        <div id="plotlyConfigZDiv">
            <span id="labelZ">Z:</span><select id="selPlotlyY" class="select-checkbox" multiple size="4"> </select>
        </div>
        <div id="plotlyConfigXYZButtons">
            <button id="btnPlotlyPlot" onclick="doPlotlyPlot('plot');">plot</button>
            <button id="btnPlotlyTable" onclick="doPlotlyPlot('table');">table</button><br>
            <button id="btnPlotlyCSV" onclick="doPlotlyPlot('csv');">export</button>
        </div>
        <div id="plotlyConfigContour"> <!-- style="float:right;"> -->
            <div id="plotlyConfigContourValue">value:<select id="selPlotlyContour"> </select></div><br>
            <div id="plotlyConfigStrides">
                depth: top <input id="txtPlotlyTopDepth" maxlength=4 type="number" min=1 max=9999 style="width: 5em;" value=0> 
                       bot <input id="txtPlotlyBotDepth" maxlength=4 type="number" min=2 max=9999 style="width: 5em;" value=990>
                bin
                <select style="vertical-align:top;" id="selPlotlyZStride">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                </select>
            </div>
            <div id="plotlyConfigContourDives">
                dives: first <input id="txtPlotlyFirstDive" maxlength=4 type="number" min=1 max=9999 style="width: 5em;" value=1> 
                       last <input id="txtPlotlyLastDive" maxlength=4 type="number" min=2 max=9999 style="width: 5em;" value=9999>
                       step <select style="vertical-align:top;" id="selPlotlyDiveStride">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                            </select>
            </div>
            <div id="plotlyConfigWhichProfiles">
                <input type="radio" id="radPlotlyDives" name="plotlyWhichProfiles" value="1"> 
                <label for="radPlotlyDives">dives</label>
                <input type="radio" id="radPlotlyClimbs" name="plotlyWhichProfiles" value="2"> 
                <label for="radPlotlyClimbs">climbs</label>
                <input type="radio" id="radPlotlyBoth" name="plotlyWhichProfiles" value="3" checked> 
                <label for="radPlotlyBoth">both</label>
                <input type="radio" id="radPlotlyCombine" name="plotlyWhichProfiles" value="4"> 
                <label for="radPlotlyCombine">combine</label>
            </div>
            <div id="plotlyConfigContourButtons">
                <button id="btnPlotlyContour" onclick="doPlotlyProfiles('contour');">contour</button>
                <button id="btnPlotlyProfiles" onclick="doPlotlyProfiles('profiles');">profiles</button>
                <input type="checkbox" checked id="chkFillGaps"><label for="chkFillGaps">fill gaps</label><br>
            </div>
        </div>
        <div id="plotlyPlotDiv">
        </div>
    </div>

    <div id="logfileDiv" class="hide" oncontextmenu="parameterHelp('logfileDiv'); return false;" title="right click/long press parameter for help" style="background-color:#eeeeee; text-align:left;">
    </div>

    <div id="engfileDiv" class="hide" style="background-color:#eeeeee; text-align:left;">
    </div>

    <div id="capfileDiv" class="hide" style="background-color:#eeeeee; text-align:left;">
    </div>
</div>

<div id="plotRibbonBox" title="a or h to move left, f or l to move right, number key 1-8 to jump to section, scroll wheel scrolls">
    <div id="plotRibbonLinks">

    </div>
    <div id="plotRibbon">

    </div>
</div>


{% if runMode == 'pilot' %}

<div id="right">
    <div id="rightHeader" style="position: relative;">
        <div id="processReport" style="display: inline-flex; aligin-items: center; min-height: 20px;">
            <span id="processLabel" style="display:inline-block; width:160px;">
                Latest job:
            </span>
            <div id="processProgressBar" onclick="popupProcessResults();">
            </div>
            &nbsp;&nbsp;&nbsp;
            <span id="processPendingCount">
                pending jobs: 0
            </span> 
        </div>

        <div id="processPopup" style="display: none;" class="process-popup">
            <div id="processPopupContents">
            </div>
            <button id="processOk" type="submit" class="btn" onclick="closeProcessResults();">ok</button>
        </div>

    </div>

    <div id="status">
        <div id="position">
        </div>
        <div id="positionTime">
        </div>
        <table id="statusTable">
            <col class="statusTableLabel">
            <col class="statusTableValue">
            <col class="statusTableLabel">
            <col class="statusTableValue">
            <col class="statusTableLabel">
            <col class="statusTableValue">
            <tr>
                <td>SOG</td><td id="SOG"></td>
                <td class="spanClick" onclick="showPlot('dv', 'ctw', true);">COG</td><td id="COG"></td>
                <td>last fix</td><td id="lastFix"></td>
            </tr>
            <tr>
                <td class="spanClick" onclick="showPlot('dv', 'ctw', true);">DOG</td><td id="DOG"></td>
                <td>&Delta;t</td><td id="dt"></td>
                <td>last call</td><td id="lastConnect"></td>
            </tr>
            <tr>
                <td class="spanClick" onclick="showPlot('eng', 'mission_commlog', true);">pitch</td><td id="pitch"></td>
                <td class="spanClick" onclick="showPlot('eng', 'mission_commlog', true);">volts</td><td id="volts"></td>
                <td>next call</td><td id="nextCall"></td>
            </tr>
            <tr>
                <td class="spanClick" onclick="showPlot('eng', 'mission_commlog', true);">depth</td><td id="depth"></td>
                <td>dive</td><td id="dive"></td>
                <td>time now</td><td id="currentTime"></td>
            </tr>
            <tr>
                <td class="spanClick" onclick="showPlot('eng', 'mission_commlog', true);">RH</td><td id="RH"></td>
                <td>cycle</td><td id="cycle"></td>
                <td>date now</td><td id="currentDate"></td>
            </tr>
            <tr>
                <td class="spanClick" onclick="showPlot('eng', 'mission_commlog', true);">int P</td><td id="intP"></td>
                <td>call</td><td id="call"></td>
            </tr>
        </table>
    </div>
    <div id="annunciators"></div>

    <div id="commlog">

    </div>

    <div id="divCmdfile">
        <div id="cmdfileEditClose" style="display:none;" onclick="defocusEditWindow(); return false;"><b>&#10060;</b></div>
        <textarea id="cmdfile" class="editFile" oncontextmenu="parameterHelp('cmdfile'); return false;" oninput="updateParmsFromCmdfile(false); controlFileMarkDirty('cmdfile');" >
        </textarea>
        <textarea id="targets" class="editFile" hidden="hidden" oninput="controlFileMarkDirty('targets');"></textarea>
        <textarea id="science" class="editFile" hidden="hidden" oninput="controlFileMarkDirty('science');"></textarea>
        <textarea id="scicon.sch" class="editFile" hidden="hidden" oninput="controlFileMarkDirty('scicon.sch');"></textarea>
        <textarea id="pdoscmds.bat" class="editFile" hidden="hidden" oninput="controlFileMarkDirty('pdoscmds.bat');"></textarea>
        <textarea id="tcm2mat.cal" class="editFile" hidden="hidden" oninput="controlFileMarkDirty('tcm2mat.cal');"></textarea>
        <textarea id="sg_calib_constants.m" class="editFile" hidden="hidden" oninput="controlFileMarkDirty('sg_calib_constants.m');"></textarea>
        <div id="fileButtons">
            <button id="btnSubmit" type="button" onclick="submitControl();" style="margin-left:2px;">Submit</button>
            <button id="btnGO" type="button" onclick="changeDirective('GO');" style="background-color:#00aa00;">GO</button>
            <button id="btnQUIT" type="button" onclick="changeDirective('QUIT');" style="background-color:#ff0020;">QUIT</button>
            <button id="btnRESUME" type="button" onclick="changeDirective('RESUME');" style="background-color:yellow;">RESUME</button>
            <select id="selectFile" onchange="changeFile()">
                <option value="cmdfile" selected>cmdfile</option>
                <option value="targets">targets</option>
                <option value="science">science</option>
                <option value="scicon.sch">scicon.sch</option>
                <option value="pdoscmds.bat">pdoscmds.bat</option>
                <option value="tcm2mat.cal">tcm2mat.cal</option>
                <option value="sg_calib_constants.m">sg_calib_constants.m</option>
            </select>
            <span id="fileDive" hidden="hidden"></span>
        </div>
    </div>
</div>  <!-- right --> 

{% endif %}

</div>  <!-- bodyView -->

<div class="form-popup" id="plotLinksPopup">

</div>

{% include "dialogs.html" %}
{% if runMode == 'pilot' %}
{% if noChat == false %}
{% include "chat.html" %}
{% endif %}
{% endif %}

</body>


</html>
